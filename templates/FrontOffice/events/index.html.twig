<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>√âv√©nements disponibles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="{{ asset('css/patient.css') }}?v=20260214-notif1">
    <link rel="stylesheet" href="{{ asset('css/eventFront.css') }}?v=1">
    <link rel="stylesheet" href="{{ asset('css/event-filter.css') }}?v=1"> <!-- üëà Nouveau fichier CSS -->
</head>

{% block body %}
    <div class="patient-app">

        <!-- TOPBAR -->
        {% include 'FrontOffice/patient/_header.html.twig' %}

        <!-- MAIN -->
        <main class="patient-main events-main">

            <!-- HERO -->
            <section class="welcome-card events-hero">
                <div class="welcome-content">
                    <h1>
                        √âv√©nements disponibles
                        <span class="wave">üéâ</span>
                    </h1>
                    <p>D√©couvrez les √©v√©nements publi√©s et choisissez celui qui vous int√©resse.</p>
                </div>
            </section>

            <!-- Flash messages -->
            {% for label, messages in app.flashes %}
                {% for msg in messages %}
                    <div class="alert alert-{{ label }} mb-3">{{ msg }}</div>
                {% endfor %}
            {% endfor %}

            <!-- SECTION FILTRE PAR TYPE D'√âV√âNEMENT -->
            <section class="events-filter-section">
                <div class="filter-card">
                    <div class="filter-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="filter-title">
                                <i class="bi bi-funnel"></i> Filtrer par type d'√©v√©nement
                            </h5>
                            
                            {% if app.request.query.get('type') %}
                                <a href="{{ path('front_events_index') }}" class="btn-reset">
                                    <i class="bi bi-x-circle"></i> R√©initialiser
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="filter-body">
                        <!-- Version 1: Filtre d√©roulant -->
                        <form method="get" action="{{ path('front_events_index') }}" class="filter-form">
                            <div class="filter-form-group">
                                <label for="type_filter" class="filter-label">
                                    <i class="bi bi-tag"></i> S√©lectionnez un type
                                </label>
                                <div class="filter-select-wrapper">
                                    <select name="type" id="type_filter" class="filter-select">
                                        <option value="">Tous les types d'√©v√©nements</option>
                                        {% for type in eventTypes %}
                                            <option value="{{ type.id }}" 
                                                {% if app.request.query.get('type') == type.id %}selected{% endif %}
                                                data-color="{{ type.couleur|default('#2d6cdf') }}">
                                                {{ type.libelle }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-form-actions">
                                <button type="submit" class="btn-filter">
                                    <i class="bi bi-search"></i> Filtrer
                                </button>
                            </div>
                        </form>
                        
                        <!-- Version 2: Filtre par chips (plus visuel) -->
                        <div class="filter-chips">
                            <a href="{{ path('front_events_index') }}" 
                               class="filter-chip {% if not app.request.query.get('type') %}active{% endif %}">
                                <i class="bi bi-grid-3x3-gap-fill"></i>
                                Tous
                            </a>
                            
                            {% for type in eventTypes %}
                                {% set isActive = app.request.query.get('type') == type.id %}
                                <a href="{{ path('front_events_index', {type: type.id}) }}" 
                                   class="filter-chip"
                                   data-color="{{ type.couleur|default('#2d6cdf') }}"
                                   {% if isActive %}data-active="true"{% endif %}>
                                    <i class="bi bi-tag"></i>
                                    {{ type.libelle }}
                                </a>
                            {% endfor %}
                        </div>
                        
                        <!-- Statistiques -->
                        <div class="filter-stats">
                            <i class="bi bi-info-circle"></i>
                            {% set totalEvents = events|length %}
                            <span class="stats-count">{{ totalEvents }}</span> √©v√©nement(s) trouv√©(s)
                            {% if app.request.query.get('type') %}
                                {% for type in eventTypes %}
                                    {% if type.id == app.request.query.get('type') %}
                                        <span class="stats-filter">
                                            ‚Ä¢ Filtre actif : <strong>{{ type.libelle }}</strong>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            {% if events is empty %}
                <section class="card events-empty-card">
                    <h2>Aucun √©v√©nement</h2>
                    <p>Aucun √©v√©nement disponible pour le moment 
                        {% if app.request.query.get('type') %}
                            avec ce type de filtre
                        {% endif %}
                        üôÇ
                    </p>
                    {% if app.request.query.get('type') %}
                        <a href="{{ path('front_events_index') }}" class="btn btn-outline-primary mt-3">
                            <i class="bi bi-arrow-left"></i> Voir tous les √©v√©nements
                        </a>
                    {% endif %}
                </section>
            {% else %}
                <section class="events-grid">
                    {% for e in events %}
                        {% set typeColor = e.type and e.type.couleur ? e.type.couleur : '#2d6cdf' %}

                        {# Calculs de participation #}
                        {% set participantsCount = e.participations is defined ? e.participations|length : 0 %}
                        {% set isFull = e.capaciteMax and participantsCount >= e.capaciteMax %}

                        {% set isParticipating = false %}
                        {% if app.user and e.participations is defined %}
                            {% for p in e.participations %}
                                {% if p.utilisateur is defined and p.utilisateur and p.utilisateur.id == app.user.id %}
                                    {% set isParticipating = true %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        <article class="event-card">

                            <div class="event-card-head">
                                <div class="event-icon" style="border-color: {{ typeColor }};">
                                    <i class="bi bi-calendar-event" style="color: {{ typeColor }};"></i>
                                </div>

                                {% if e.type %}
                                    <span class="event-pill" style="--c: {{ typeColor }};">
                                        <i class="bi bi-tag"></i>
                                        {{ e.type.libelle }}
                                    </span>
                                {% endif %}
                            </div>

                            <h3 class="event-title">{{ e.titre }}</h3>

                            <p class="event-desc">
                                {{ e.description|default('')|length > 0 ? e.description|slice(0,120) ~ '‚Ä¶' : 'Aucune description.' }}
                            </p>

                            <div class="event-meta">
                                <div class="event-meta-row">
                                    <i class="bi bi-clock"></i>
                                    <span class="meta-label">Date :</span>
                                    <span class="meta-value">{{ e.dateDebut ? e.dateDebut|date('d/m/Y H:i') : 'Non d√©finie' }}</span>
                                </div>

                                <div class="event-meta-row">
                                    <i class="bi bi-geo-alt"></i>
                                    <span class="meta-label">Lieu :</span>
                                    <span class="meta-value">{{ e.lieu ? e.lieu : 'Non d√©fini' }}</span>
                                </div>

                                <div class="event-meta-row">
                                    <i class="bi bi-people"></i>
                                    <span class="meta-label">Capacit√© :</span>
                                    <span class="meta-value">{{ e.capaciteMax ? e.capaciteMax : '‚Äî' }}</span>
                                </div>
                            </div>

                            <div class="event-stats mt-2 small">
                                <div class="mb-1">
                                    <i class="bi bi-people"></i>
                                    <strong>Participants :</strong>
                                    {{ participantsCount }}/{{ e.capaciteMax }}
                                </div>

                                <div class="mb-1">
                                    <i class="bi bi-megaphone"></i>
                                    <strong>Statut :</strong>
                                    {{ e.statut|default('BROUILLON') }}
                                </div>

                                {% if isParticipating %}
                                    <div class="text-success">
                                        <i class="bi bi-check-circle"></i>
                                        Vous participez
                                    </div>
                                {% endif %}
                            </div>

                            {% if e.image %}
                                <div class="event-image">
                                    <img src="{{ asset('uploads/events/' ~ e.image) }}" alt="Image event" loading="lazy">
                                </div>
                            {% endif %}

                            <!-- Boutons participer / annuler -->
                            <div class="event-actions d-flex gap-2 mt-3">
                                {% if app.user is null %}
                                    <a class="btn btn-outline-primary w-100" href="{{ path('app_login') }}">
                                        <i class="bi bi-box-arrow-in-right"></i>
                                        Se connecter
                                    </a>
                                {% else %}
                                    <form method="post" action="{{ path('front_events_participer', {id: e.id}) }}" style="flex:1;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('front_participer_' ~ e.id) }}">
                                        <button type="submit" class="btn btn-success w-100" {% if isParticipating or isFull %} disabled {% endif %}>
                                            <i class="bi bi-check2-circle"></i>
                                            Participer
                                        </button>
                                    </form>

                                    {% if isParticipating %}
                                        <form method="post" action="{{ path('front_events_annuler', {id: e.id}) }}" style="flex:1;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('front_annuler_' ~ e.id) }}">
                                            <button type="submit" class="btn btn-outline-danger w-100">
                                                <i class="bi bi-x-circle"></i>
                                                Annuler
                                            </button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <a class="event-btn mt-3" href="{{ path('front_events_show', {id: e.id}) }}">
                                Voir d√©tails
                                <i class="bi bi-arrow-right"></i>
                            </a>

                        </article>
                    {% endfor %}
                </section>
            {% endif %}

        </main>
    </div>

    <script>
        window.addEventListener('scroll', () => {
            document.querySelector('.topbar')?.classList.toggle('is-scrolled', window.scrollY > 10);
        });
        
        // Appliquer les couleurs aux chips
        document.addEventListener('DOMContentLoaded', function() {
            const chips = document.querySelectorAll('.filter-chip[data-color]');
            chips.forEach(chip => {
                const color = chip.dataset.color;
                if (chip.hasAttribute('data-active')) {
                    chip.style.backgroundColor = color;
                    chip.style.borderColor = color;
                    chip.style.color = 'white';
                } else if (!chip.classList.contains('active')) {
                    chip.style.borderColor = color;
                    chip.style.color = color;
                }
            });
        });
    </script>
{% endblock %}
</html>