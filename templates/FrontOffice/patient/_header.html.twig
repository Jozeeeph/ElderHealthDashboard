<style>
	.notif-toast-stack {
		position: fixed;
		top: 86px;
		right: 18px;
		width: min(380px, 90vw);
		display: grid;
		gap: 10px;
		z-index: 1200;
	}

	.notif-toast {
		padding: 10px 12px;
		border-radius: 12px;
		border: 1px solid #dbeafe;
		background: #eff6ff;
		box-shadow: 0 12px 22px rgba(15, 23, 42, 0.14);
		color: #1e293b;
		font-size: 0.86rem;
		font-weight: 600;
	}

	.notif-toast.is-overdue {
		border-color: #fecaca;
		background: #fff1f2;
		color: #9f1239;
	}

	.notif-toast-actions {
		margin-top: 8px;
		display: flex;
		align-items: center;
		justify-content: flex-end;
		gap: 8px;
	}

	.notif-hide-btn {
		border: 1px solid #cbd5e1;
		background: #ffffff;
		color: #334155;
		border-radius: 999px;
		padding: 3px 10px;
		font-size: 0.74rem;
		font-weight: 700;
		line-height: 1.3;
		cursor: pointer;
	}

	.notif-hide-btn:hover {
		background: #f8fafc;
	}

	@media (max-width: 768px) {
		.notif-toast-stack {
			top: 74px;
			right: 10px;
			width: calc(100vw - 20px);
		}
	}
</style>
<header class="topbar">
	<div
		class="topbar-inner">

		<!-- BRAND -->
		<a href="{{ path('app_public_site') }}" class="brand">
			<img src="{{ asset('img/logo.png') }}" alt="Elder HealthCare">
			<span class="brand-text">
				<span class="fw-bold text-primary">Elder</span>
				<span class="fw-bold text-warning ms-1">HealthCare</span>
			</span>
		</a>

		{% set currentRoute = app.request.attributes.get('_route') %}
		{% set isNurse = is_granted('ROLE_PERSONNEL_MEDICAL') %}
		{% set homeRoute = isNurse ? 'app_infermier_interface' : 'app_patient_interfce' %}
		{% set rendezVousRoute = isNurse ? 'front_infermier_rendezvous_index' : 'patient_rendezvous_index' %}
		{% set calendarRoute = isNurse ? 'front_infermier_calendar_index' : '' %}
		{% set consultationRoute = isNurse ? 'front_infermier_consultation_index' : 'patient_consultations' %}
		{% set profileRoute = isNurse ? 'front_infermier_profile' : 'patient_profile' %}
		{% set forumRoute = isNurse ? 'front_infermier_forum_index' : 'forum_post_forum_index' %}
		{% set notif = header_notifications() %}
		{% set rendezVousActive = isNurse ? (currentRoute starts with 'front_infermier_rendezvous_') : (currentRoute starts with 'patient_rendezvous') %}
		{% set calendarActive = isNurse and (currentRoute starts with 'front_infermier_calendar_') %}
		{% set consultationActive = isNurse
            ? (currentRoute starts with 'front_infermier_consultation_' or currentRoute starts with 'front_infermier_prescription_' or currentRoute starts with 'front_infermier_rapport_')
            : (currentRoute == 'patient_consultations' or currentRoute == 'patient_prescription_show' or currentRoute == 'patient_rapport_show' or currentRoute == 'patient_prescription_pdf' or currentRoute == 'patient_rapport_pdf') %}
		{% set forumActive = isNurse ? (currentRoute starts with 'front_infermier_forum_') : (currentRoute starts with 'forum_post_forum_') %}

		<!-- NAV -->
		<nav class="top-nav">
			<a href="{{ path(homeRoute) }}" class="{{ currentRoute == homeRoute ? 'active' }}">
				Accueil
			</a>

			<a href="{{ path(rendezVousRoute) }}" class="{{ rendezVousActive ? 'active' }}">
				Rendez-vous
			</a>
			{% if isNurse %}
				<a href="{{ path(calendarRoute) }}" class="{{ calendarActive ? 'active' }}">
					Calendrier
				</a>
			{% endif %}

			<a href="{{ path(consultationRoute) }}" class="{{ consultationActive ? 'active' }}">
				Consultation
			</a>
			{% if not isNurse %}
				<a href="{{ path('front_equipements_index') }}" class="{{ currentRoute starts with 'equipment_' ? 'active' }}">
					Equipement
				</a>
			{% endif %}

			<a href="{{ path(forumRoute) }}" class="{{ forumActive ? 'active' }}">
				Forum
			</a>

			<a href="{{ path('front_events_index') }}" class="{{ currentRoute starts with 'front_events' ? 'active' }}">
				Evenements
			</a>

			{# <a class="{{ currentRoute starts with 'messages_' ? 'active' }}">
			                Messages
			            </a>
			
			            <a class="{{ currentRoute starts with 'alerts_' ? 'active' }}">
			                Alertes
			            </a> #}
		</nav>

		<!-- PROFILE -->
		<div class="topbar-right">
			{% if not isNurse %}
				<a href="{{ path('cart_view') }}" class="notif-link" title="Panier">
					<i class="bi bi-cart3"></i>
					{% set cartSession = app.session.get('cart')|default([]) %}
					{% if cartSession is not empty %}
						<span class="notif-badge">{{ cartSession|length }}</span>
					{% endif %}
				</a>
			{% endif %}

			<button type="button" class="notif-link {{ notif.hasNew ? 'has-new' : '' }}" title="Notifications" data-notif-toggle aria-expanded="false">
				<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
					<path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2a2 2 0 0 1-.6 1.4L4 17h5m6 0a3 3 0 0 1-6 0m6 0H9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
				{% if notif.count > 0 %}
					<span class="notif-badge">{{ notif.count > 9 ? '9+' : notif.count }}</span>
				{% endif %}
			</button>
			<div class="notif-panel" data-notif-panel hidden>
				<div class="notif-panel-head">
					<span>Stock notifications</span>
					{% if notif.count > 0 %}
						<form method="post" action="{{ path('app_notifications_clear_all') }}" class="notif-clear-form">
							<input type="hidden" name="_token" value="{{ csrf_token('clear_all_notifications') }}">
							<button type="submit" class="notif-clear-btn">Clean all</button>
						</form>
					{% endif %}
				</div>
				<div class="notif-panel-body">
					{% if notif.items is not empty %}
						{% for item in notif.items %}
							{% if item is iterable %}
								<div class="notif-item {{ item.overdue is defined and item.overdue ? 'is-overdue' : '' }}">
									<div class="notif-text">{{ item.message }}</div>
									{% if not isNurse and item.type is defined and item.type == 'prescription_reminder' and item.prescription_id is defined and item.scheduled_at is defined and item.token_id is defined %}
										<form method="post" action="{{ path('patient_prescription_reminder_done') }}" class="notif-action-form">
											<input type="hidden" name="_token" value="{{ csrf_token(item.token_id) }}">
											<input type="hidden" name="prescription_id" value="{{ item.prescription_id }}">
											<input type="hidden" name="scheduled_at" value="{{ item.scheduled_at }}">
											<button type="submit" class="notif-done-btn">C'est bon</button>
										</form>
									{% elseif not isNurse and item._key is defined %}
										<form method="post" action="{{ path('app_notifications_clear_one') }}" class="notif-action-form">
											<input type="hidden" name="_token" value="{{ csrf_token('clear_one_notification_' ~ item._key) }}">
											<input type="hidden" name="key" value="{{ item._key }}">
											<button type="submit" class="notif-done-btn">C'est bon</button>
										</form>
									{% endif %}
								</div>
							{% else %}
								<div class="notif-item">{{ item }}</div>
							{% endif %}
						{% endfor %}
					{% else %}
						<div class="notif-empty">Aucune notification</div>
					{% endif %}
				</div>
			</div>

			<a class="profile" href="{{ path(profileRoute) }}">
				<div class="profile-emoji"></div>
				<strong>
					{{ app.user ? app.user.prenom ~ ' ' ~ app.user.nom : 'Patient' }}
				</strong>
			</a>
		</div>

	</div>
</header>

{% if notif.toast_items is not empty %}
	<div class="notif-toast-stack" data-notif-toast-stack>
		{% for item in notif.toast_items %}
			{% if item is iterable %}
				<div class="notif-toast {{ item.overdue is defined and item.overdue ? 'is-overdue' : '' }}" data-notif-toast>
					<div class="notif-text">{{ item.message }}</div>
					<div class="notif-toast-actions">
						{% if item.type is defined and item.type == 'prescription_reminder' %}
							<form method="post" action="{{ path('patient_prescription_reminder_done') }}" class="notif-action-form">
								<input type="hidden" name="_token" value="{{ csrf_token(item.token_id) }}">
								<input type="hidden" name="prescription_id" value="{{ item.prescription_id }}">
								<input type="hidden" name="scheduled_at" value="{{ item.scheduled_at }}">
								<button type="submit" class="notif-done-btn">C'est bon</button>
							</form>
						{% endif %}
						<button type="button" class="notif-hide-btn" data-notif-hide>Hide</button>
					</div>
				</div>
			{% else %}
				<div class="notif-toast" data-notif-toast>
					<div class="notif-text">{{ item }}</div>
					<div class="notif-toast-actions">
						<button type="button" class="notif-hide-btn" data-notif-hide>Hide</button>
					</div>
				</div>
			{% endif %}
		{% endfor %}
	</div>
{% endif %}

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const toggle = document.querySelector('[data-notif-toggle]');
		const panel = document.querySelector('[data-notif-panel]');

		if (toggle && panel) {
			toggle.addEventListener('click', function (event) {
				event.preventDefault();
				event.stopPropagation();
				const isOpen = panel.classList.toggle('is-open');
				panel.hidden = !isOpen;
				toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
			});

			document.addEventListener('click', function (event) {
				if (!panel.classList.contains('is-open')) {
					return;
				}
				if (panel.contains(event.target) || toggle.contains(event.target)) {
					return;
				}
				panel.classList.remove('is-open');
				panel.hidden = true;
				toggle.setAttribute('aria-expanded', 'false');
			});
		}

		const stack = document.querySelector('[data-notif-toast-stack]');
		if (!stack) {
			return;
		}

		stack.querySelectorAll('[data-notif-toast]').forEach(function (toast) {
			window.setTimeout(function () {
				if (toast && toast.parentNode) {
					toast.remove();
				}
			}, 5000);
		});

		stack.addEventListener('click', function (event) {
			const button = event.target.closest('[data-notif-hide]');
			if (!button) {
				return;
			}
			const toast = button.closest('[data-notif-toast]');
			if (!toast) {
				return;
			}
			toast.remove();
		});
	});
</script>
