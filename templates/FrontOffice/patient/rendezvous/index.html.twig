{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('css/patient.css') }}?v=20260214-notif1">
	<link rel="stylesheet" href="{{ asset('css/patient-rendezvous.css') }}?v=20260214-7">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

{% endblock %}

{% block public_nav %}{% endblock %}

{% block body %}
	<div class="patient-app">

		{% include 'FrontOffice/patient/_header.html.twig' %}

		<main class="patient-main">
			<section class="welcome-card">
				<div class="welcome-content">
					<h1>Mes rendez-vous</h1>
					<p>Consultez et ajoutez vos rendez-vous.</p>
					<div class="actions">
						<a class="btn primary" href="{{ path('patient_rendezvous_new') }}">Prendre rendez-vous</a>
					</div>
				</div>
			</section>

			{% for message in app.flashes('success') %}
				<div class="rdv-flash rdv-flash-success" role="alert">
					<div class="rdv-flash-text">{{ message }}</div>
					<button type="button" class="rdv-flash-close" aria-label="Fermer">x</button>
				</div>
			{% endfor %}

			<section class="content-grid">
				<div class="card" style="grid-column: 1 / -1;">
					<h2>Liste des rendez-vous</h2>

					<div class="rdv-filters">
						<div class="rdv-filters-grid">
							<div class="rdv-filter-field rdv-filter-field-search">
								<label class="rdv-filter-label" for="rdv-filter-search">Recherche</label>
								<input id="rdv-filter-search" class="rdv-filter-input" type="text" placeholder="Lieu, personnel, type ou etat">
							</div>
							<div class="rdv-filter-field">
								<label class="rdv-filter-label" for="rdv-filter-date">Date</label>
								<input id="rdv-filter-date" class="rdv-filter-input" type="date">
							</div>
							<div class="rdv-filter-field">
								<label class="rdv-filter-label" for="rdv-filter-etat">Etat</label>
								<select id="rdv-filter-etat" class="rdv-filter-select">
									<option value="">Tous</option>
									<option value="EN_ATTENTE">En attente</option>
									<option value="PLANIFIE">Planifie</option>
									<option value="EN_COURS">En cours</option>
									<option value="TERMINE">Termine</option>
									<option value="ANNULEE">Annulee</option>
									<option value="REFUSEE">Refusee</option>
								</select>
							</div>
							<div class="rdv-filter-actions">
								<button type="button" class="rdv-filter-btn rdv-filter-btn-primary" id="rdv-filter-apply">
									Filtrer
								</button>
								<button type="button" class="rdv-filter-btn rdv-filter-btn-secondary" id="rdv-filter-reset">
									Reset
								</button>
							</div>
						</div>
					</div>

					{% if rendezVousList is empty %}
						<div class="item">
							<strong>Aucun rendez-vous</strong>
							<p>Commencez par ajouter un nouveau rendez-vous.</p>
						</div>
					{% else %}
						<div class="rdv-cards">
							{% for rdv in rendezVousList %}
								<div class="rdv-card fade-in"
									data-date="{{ rdv.date|date('Y-m-d') }}"
									data-etat="{{ rdv.etat|upper }}"
									data-search="{{ (rdv.lieu ~ ' ' ~ (rdv.personnelMedical ? (rdv.personnelMedical.nom ~ ' ' ~ rdv.personnelMedical.prenom) : '') ~ ' ' ~ (rdv.typeRendezVous ? rdv.typeRendezVous.type : '') ~ ' ' ~ rdv.etat)|lower }}">
									<div class="rdv-main">
										<div class="rdv-meta">
											<div class="rdv-date">
												<i class="bi bi-calendar"></i>
												{{ rdv.date|date('d/m/Y') }}
											</div>
											<div class="rdv-time">
												<i class="bi bi-clock"></i>
												{{ rdv.heure|date('H:i') }}
											</div>
											<div class="rdv-place">
												<i class="bi bi-geo-alt"></i>
												{{ rdv.lieu|slice(0, 40) }}{{ rdv.lieu|length > 40 ? '...' : '' }}
											</div>
										</div>
										<div class="rdv-people">
											<div class="rdv-personnel">
												<span class="label">Personnel</span>
												<span class="value">
													{{ rdv.personnelMedical ? (rdv.personnelMedical.nom ~ ' ' ~ rdv.personnelMedical.prenom) : 'Non assigne' }}
												</span>
											</div>
											<div class="rdv-patient">
												<span class="label">Patient</span>
												<span class="value">
													{{ rdv.patient ? (rdv.patient.nom ~ ' ' ~ rdv.patient.prenom) : 'Non assigne' }}
												</span>
											</div>
										</div>
									</div>
									<div class="rdv-side">
										<div class="rdv-type">
											<span class="badge bg-info text-white">
												{{ rdv.typeRendezVous.type }}
											</span>
										</div>
										<div class="rdv-status">
											{% set etatClass = {
											'EN_ATTENTE': 'status-en_attente',
											'PLANIFIE': 'status-planifiee',
											'PLANIFIEE': 'status-planifiee',
											'EN_COURS': 'status-en_cours',
											'TERMINE': 'status-terminee',
											'TERMINEE': 'status-terminee',
											'ANNULEE': 'status-annulee',
											'REFUSEE': 'status-refusee'
										} %}
											<span class="status-badge {{ etatClass[rdv.etat] ?? 'status-planifiee' }}">
												{{ rdv.etat|replace({'_': ' '})|lower|title }}
											</span>
										</div>
										<div class="rdv-actions">
											{% if rdv.etat != 'REFUSEE' %}
												<a class="btn-action edit" href="{{ path('patient_rendezvous_edit', {'id': rdv.id}) }}" title="Modifier">
													<i class="bi bi-pencil"></i>
												</a>
											{% endif %}
											{% if rdv.etat in ['ANNULEE', 'TERMINE', 'TERMINEE', 'REFUSEE'] %}
												<a class="btn-action delete js-delete" href="{{ path('patient_rendezvous_delete', {'id': rdv.id}) }}" title="Supprimer">
													<i class="bi bi-trash"></i>
												</a>
											{% else %}
												<a class="btn-action delete js-delete" href="{{ path('patient_rendezvous_cancel', {'id': rdv.id}) }}" title="Annuler">
													<i class="bi bi-x-circle"></i>
												</a>
											{% endif %}
										</div>
									</div>
								</div>
							{% endfor %}
						</div>
					{% endif %}

					{% if pagination is defined and pagination.pages > 1 %}
						<section class="card mt-3">
							<div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
								<div class="muted">
									Page {{ pagination.page }} / {{ pagination.pages }} - {{ pagination.total }} rendez-vous
								</div>
								<nav aria-label="Pagination rendez-vous patient">
									<ul class="pagination mb-0">
										<li class="page-item {{ pagination.page <= 1 ? 'disabled' : '' }}">
											<a class="page-link" href="{{ path('patient_rendezvous_index', { page: pagination.page - 1 }) }}">Precedent</a>
										</li>
										{% for p in 1..pagination.pages %}
											<li class="page-item {{ p == pagination.page ? 'active' : '' }}">
												<a class="page-link" href="{{ path('patient_rendezvous_index', { page: p }) }}">{{ p }}</a>
											</li>
										{% endfor %}
										<li class="page-item {{ pagination.page >= pagination.pages ? 'disabled' : '' }}">
											<a class="page-link" href="{{ path('patient_rendezvous_index', { page: pagination.page + 1 }) }}">Suivant</a>
										</li>
									</ul>
								</nav>
							</div>
						</section>
					{% endif %}
				</div>
			</section>
		</main>
	</div>
{% endblock %}

{% block javascripts %}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const searchInput = document.getElementById('rdv-filter-search');
			const dateInput = document.getElementById('rdv-filter-date');
			const etatInput = document.getElementById('rdv-filter-etat');
			const applyBtn = document.getElementById('rdv-filter-apply');
			const resetBtn = document.getElementById('rdv-filter-reset');
			const cards = document.querySelectorAll('.rdv-card');

			if (!cards.length || !searchInput || !dateInput || !etatInput || !applyBtn || !resetBtn) {
				return;
			}

			const normalizeEtat = function (value) {
				const raw = (value || '').toString().toUpperCase();
				if (raw === 'PLANIFIEE') {
					return 'PLANIFIE';
				}
				if (raw === 'TERMINEE') {
					return 'TERMINE';
				}
				return raw;
			};

			const applyFilters = function () {
				const searchVal = (searchInput.value || '').toLowerCase().trim();
				const dateVal = dateInput.value || '';
				const etatVal = normalizeEtat(etatInput.value);

				cards.forEach(function (card) {
					const cardSearch = (card.dataset.search || '').toLowerCase();
					const cardDate = card.dataset.date || '';
					const cardEtat = normalizeEtat(card.dataset.etat || '');

					const matchSearch = !searchVal || cardSearch.includes(searchVal);
					const matchDate = !dateVal || cardDate === dateVal;
					const matchEtat = !etatVal || cardEtat === etatVal;

					card.style.display = (matchSearch && matchDate && matchEtat) ? '' : 'none';
				});
			};

			applyBtn.addEventListener('click', applyFilters);
			searchInput.addEventListener('keydown', function (event) {
				if (event.key === 'Enter') {
					event.preventDefault();
					applyFilters();
				}
			});
			dateInput.addEventListener('change', applyFilters);
			etatInput.addEventListener('change', applyFilters);
			resetBtn.addEventListener('click', function () {
				searchInput.value = '';
				dateInput.value = '';
				etatInput.value = '';
				applyFilters();
			});

			document.querySelectorAll('.rdv-flash-close').forEach(function (btn) {
				btn.addEventListener('click', function () {
					const flash = btn.closest('.rdv-flash');
					if (!flash) {
						return;
					}
					flash.style.opacity = '0';
					flash.style.transform = 'translateY(-4px)';
					setTimeout(function () {
						flash.remove();
					}, 180);
				});
			});
		});
	</script>
{% endblock %}
