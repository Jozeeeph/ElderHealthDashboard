<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<title>Forum communautaire</title>
		<meta
		name="viewport" content="width=device-width, initial-scale=1">

		{# Bootstrap CSS #}
		<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

		{# Bootstrap Icons #}
		<link
		href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

		{# Your CSS #}
		<link rel="stylesheet" href="{{ asset('css/patient.css') }}?v=20260214-notif1">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
		<link rel="stylesheet" href="{{ asset('css/equipementFront.css') }}?v=2">
	</head>

	{% block body %}

		{% include 'FrontOffice/patient/_header.html.twig' %}


		<div
			class="products-page">
			<!-- Hero Section -->
			<section class="hero-section">
				<h1 class="hero-title">Equipements Medicaux</h1>
				<p class="hero-subtitle">Decouvrez notre selection d'equipements medicaux de qualite pour professionnels et particuliers</p>
				<div class="d-flex justify-content-end mb-3">
					<a href="{{ path('cart_view') }}" class="btn btn-outline-secondary position-relative">
						<i class="bi bi-cart"></i>
						Panier
						<span id="cart-count" class="badge bg-danger rounded-pill ms-2">{{ (app.session.get('cart')|default([]))|length }}</span>
					</a>
				</div>

				<!-- Search Bar -->
				<div class="search-container">
					<div class="search-box">
						<input type="text" id="equipment-search-input" placeholder="Rechercher un équipement..." class="search-input" autocomplete="off">
						<button class="search-button" type="button" aria-label="Rechercher">
							<i class="bi bi-search"></i>
						</button>
					</div>
				</div>
			</section>

			<!-- Categories -->
			<section class="categories-section">
				<div class="categories-container">
					<a href="{{ path('front_equipements_index') }}?sort={{ current_sort|default('best_sellers') }}" class="category-btn {% if current_category is not defined or current_category is null %}active{% endif %}">
						Tous les produits
					</a>
					{% set categories = [] %}
					{% for equipement in equipements %}
						{% if equipement.categorie and equipement.categorie not in categories %}
							{% set categories = categories|merge([equipement.categorie]) %}
							<a href="{{ path('front_equipements_by_category', {'categorie': equipement.categorie}) }}?sort={{ current_sort|default('best_sellers') }}" class="category-btn {% if current_category is defined and current_category == equipement.categorie %}active{% endif %}">
								{{ equipement.categorie }}
							</a>
						{% endif %}
					{% endfor %}
				</div>
			</section>

			<!-- Products Grid -->
			<section class="products-section">
				<div class="products-header">
					<h2 class="section-title">
						{% if current_category is defined and current_category %}
							{{ current_category }}
						{% else %}
							Tous les Equipements
						{% endif %}
						<span id="products-count" class="products-count">({{ equipements|length }}
							produits)</span>
					</h2>

					<div class="sort-container">
						<span class="sort-label">Trier par :</span>
						<form method="get" action="{% if current_category is defined and current_category %}{{ path('front_equipements_by_category', {'categorie': current_category}) }}{% else %}{{ path('front_equipements_index') }}{% endif %}">
							<select class="sort-select" name="sort" onchange="this.form.submit()">
								<option value="best_sellers" {% if current_sort|default('best_sellers') == 'best_sellers' %}selected{% endif %}>Meilleurs ventes</option>
								<option value="price_asc" {% if current_sort|default('best_sellers') == 'price_asc' %}selected{% endif %}>Prix croissant</option>
								<option value="price_desc" {% if current_sort|default('best_sellers') == 'price_desc' %}selected{% endif %}>Prix dÃ©croissant</option>
								<option value="newest" {% if current_sort|default('best_sellers') == 'newest' %}selected{% endif %}>NouveautÃ©s</option>
							</select>
						</form>
					</div>
				</div>

				<div id="products-results" data-search-url="{{ path('front_equipements_search_ajax') }}" data-current-category="{{ current_category|default('') }}" data-current-sort="{{ current_sort|default('best_sellers') }}">
					{% include 'FrontOffice/equipement/_products_results.html.twig' with { equipements: equipements } %}
				</div>
			</section>
		</div>

		<!-- JavaScript -->
		 <script>
				    function addToCart(equipementId) {
				        fetch('/api/panier/ajouter/' + equipementId, {
				            method: 'POST',
				            headers: {
				                'Content-Type': 'application/json',
				                'X-CSRF-Token': '{{ csrf_token('add_to_cart') }}'
				            }
				        })
				        .then(response => response.json())
				        .then(data => {
				            if (data.success) {
				                showNotification('Produit ajoutÃ© au panier !', 'success');
				                updateCartCount(data.cartCount);
				            } else {
				                showNotification('Erreur lors de l\'ajout au panier', 'error');
				            }
				        })
				        .catch(error => {
				            console.error('Error:', error);
				            showNotification('Erreur de connexion', 'error');
				        });
				    }
				
				    function showNotification(message, type) {
				        const notification = document.createElement('div');
				        notification.style.cssText = `
				            position: fixed;
				            top: 20px;
				            right: 20px;
				            padding: 15px 20px;
				            background: ${type === 'success' ? '#4CAF50' : '#f44336'};
				            color: white;
				            border-radius: 10px;
				            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
				            z-index: 1000;
				            animation: slideIn 0.3s ease;
				        `;
				        notification.textContent = message;
				        
				        document.body.appendChild(notification);
				        
				        setTimeout(() => {
				            notification.style.animation = 'slideOut 0.3s ease';
				            setTimeout(() => notification.remove(), 300);
				        }, 3000);
				    }
				
				    function updateCartCount(count) {
				        const cartCount = document.getElementById('cart-count');
				        if (cartCount) {
				            cartCount.textContent = count;
				            cartCount.style.animation = 'bounce 0.3s';
				            setTimeout(() => cartCount.style.animation = '', 300);
				        }
				    }
				const searchInput = document.getElementById('equipment-search-input');
				const productsResults = document.getElementById('products-results');
				const productsCount = document.getElementById('products-count');
				const searchButton = document.querySelector('.search-button');

				if (searchInput && productsResults) {
					const searchUrl = productsResults.dataset.searchUrl;
					const currentCategory = productsResults.dataset.currentCategory || '';
					const currentSort = productsResults.dataset.currentSort || 'best_sellers';
					let debounceTimer = null;

					const runSearch = () => {
						clearTimeout(debounceTimer);
						debounceTimer = setTimeout(async () => {
							const params = new URLSearchParams({
								q: searchInput.value,
								sort: currentSort,
								category: currentCategory
							});

							try {
								const response = await fetch(`${searchUrl}?${params.toString()}`, {
									headers: {
										'X-Requested-With': 'XMLHttpRequest'
									}
								});

								if (!response.ok) {
									return;
								}

								const data = await response.json();
								productsResults.innerHTML = data.html;
								if (productsCount) {
									productsCount.textContent = `(${data.count} produits)`;
								}
							} catch (error) {
								console.error('Erreur de recherche AJAX:', error);
							}
						}, 250);
					};

					searchInput.addEventListener('input', runSearch);
					if (searchButton) {
						searchButton.addEventListener('click', runSearch);
					}
				}
				    // Animation CSS
				    const style = document.createElement('style');
				    style.textContent = `
				        @keyframes slideIn {
				            from { transform: translateX(100%); opacity: 0; }
				            to { transform: translateX(0); opacity: 1; }
				        }
				        @keyframes slideOut {
				            from { transform: translateX(0); opacity: 1; }
				            to { transform: translateX(100%); opacity: 0; }
				        }
				        @keyframes bounce {
				            0%, 100% { transform: scale(1); }
				            50% { transform: scale(1.2); }
				        }
				    `;
				    document.head.appendChild(style);
				</script>
	{% endblock %}
</html>

