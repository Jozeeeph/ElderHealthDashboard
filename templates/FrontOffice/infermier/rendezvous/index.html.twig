{% block stylesheets %}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="{{ asset('css/infermier.css') }}?v=20260214-7">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block body %}
	<div class="nurse-app">
		{% include 'FrontOffice/infermier/_header.html.twig' %}
		<main class="nurse-main consultation-page">
			<section class="consultation-header">
				<div class="card-head">
					<div>
						<h2 class="consultation-title">
							{{ (currentView ?? 'all') == 'planned' ? 'Mes rendez-vous planifies' : 'Demandes de rendez-vous' }}
						</h2>
						<p class="consultation-subtitle">
							{{ (currentView ?? 'all') == 'planned'
								? 'Consultez uniquement les rendez-vous deja planifies.'
								: 'Acceptez ou refusez les demandes de vos patients.' }}
						</p>
					</div>
					<div class="consult-view-actions">
						<a href="{{ path('front_infermier_rendezvous_index') }}" class="consult-view-btn {{ (currentView ?? 'all') == 'all' ? 'active' : '' }}">Tous</a>
						<a href="{{ path('front_infermier_rendezvous_planned') }}" class="consult-view-btn {{ (currentView ?? 'all') == 'planned' ? 'active' : '' }}">Planifies</a>
					</div>
				</div>
			</section>

			<section class="card consult-filters mt-3">
				<div class="card-head mb-2">
					<h2>Recherche par date</h2>
				</div>
				<div class="consult-filters-grid">
					<div class="consult-filter-field">
						<label class="consult-filter-label" for="rdv-filter-date">Date du rendez-vous</label>
						<input id="rdv-filter-date" class="consult-filter-input" type="date">
					</div>
					<div class="consult-filter-actions">
						<button type="button" class="consult-filter-btn consult-filter-btn-primary" id="rdv-filter-apply">Filtrer</button>
						<button type="button" class="consult-filter-btn consult-filter-btn-secondary" id="rdv-filter-reset">Reinitialiser</button>
					</div>
				</div>
			</section>

			{% for message in app.flashes('success') %}
				<div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}

			<section class="grid consult-grid">
				{% for rdv in rendezVousList %}
					{% set etatClass = {
						'EN_ATTENTE': 'status-en_attente',
						'PLANIFIE': 'status-planifiee',
						'PLANIFIEE': 'status-planifiee',
						'EN_COURS': 'status-en_cours',
						'TERMINE': 'status-terminee',
						'TERMINEE': 'status-terminee',
						'ANNULEE': 'status-annulee',
						'REFUSEE': 'status-refusee'
					} %}
					{% set status = rdv.etat ? rdv.etat|lower : '' %}
					<div class="card consultation-card" data-status="{{ status }}" data-date="{{ rdv.date ? rdv.date|date('Y-m-d') : '' }}">
						<div class="consultation-accent"></div>
						<div class="card-head">
							<h2 class="consultation-card-icon" title="Rendez-vous">
								<i class="bi bi-calendar2-week"></i>
								<span class="visually-hidden">Rendez-vous</span>
							</h2>
							<span class="status-badge {{ etatClass[rdv.etat] ?? 'status-planifiee' }}">
								{{ rdv.etat|replace({'_': ' '})|lower|title }}
							</span>
						</div>
						<div class="consultation-meta">
							<span class="consultation-chip chip-green" title="Patient">
								<i class="bi bi-person-circle"></i>
								{{ rdv.patient ? (rdv.patient.prenom ~ ' ' ~ rdv.patient.nom) : '-' }}
							</span>
							<span class="consultation-chip" title="Type de rendez-vous">
								<i class="bi bi-bookmark-heart"></i>
								{{ rdv.typeRendezVous ? rdv.typeRendezVous.type : '-' }}
							</span>
							<span class="consultation-chip chip-blue" title="Personnel medical">
								<i class="bi bi-person-badge"></i>
								{{ rdv.personnelMedical ? (rdv.personnelMedical.prenom ~ ' ' ~ rdv.personnelMedical.nom) : '-' }}
							</span>
						</div>
						<div class="consultation-meta">
							<span class="consultation-chip chip-amber" title="Date">
								<i class="bi bi-calendar-event"></i>
								{{ rdv.date ? rdv.date|date('d/m/Y') : '-' }}
							</span>
							<span class="consultation-chip chip-amber" title="Heure">
								<i class="bi bi-clock"></i>
								{{ rdv.heure ? rdv.heure|date('H:i') : '-' }}
							</span>
							{% if rdv.lieu %}
								<span class="consultation-chip chip-pink" title="Lieu">
									<i class="bi bi-geo-alt"></i>
									{{ rdv.lieu }}
								</span>
							{% endif %}
						</div>
						<div class="consultation-actions">
							{% if rdv.etat == 'EN_ATTENTE' %}
								<a class="btn-sm primary" href="{{ path('front_infermier_rendezvous_accept', {'id': rdv.id}) }}">Accepter</a>
								<a class="btn-sm danger" href="{{ path('front_infermier_rendezvous_refuse', {'id': rdv.id}) }}">Refuser</a>
							{% endif %}
						</div>
					</div>
				{% else %}
					<div class="card consultation-card">
						<div class="consultation-accent"></div>
						<p class="muted">Aucun rendez-vous pour le moment.</p>
					</div>
				{% endfor %}
			</section>
			{% if pagination.pages > 1 %}
				<section class="card mt-3">
					<div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
						<div class="muted">
							Page {{ pagination.page }} / {{ pagination.pages }} - {{ pagination.total }} rendez-vous
						</div>
						<nav aria-label="Pagination rendez-vous infirmier">
							<ul class="pagination mb-0">
								<li class="page-item {{ pagination.page <= 1 ? 'disabled' : '' }}">
									<a class="page-link" href="{{ path(paginationRoute ?? 'front_infermier_rendezvous_index', { page: pagination.page - 1 }) }}">Precedent</a>
								</li>
								{% for p in 1..pagination.pages %}
									<li class="page-item {{ p == pagination.page ? 'active' : '' }}">
										<a class="page-link" href="{{ path(paginationRoute ?? 'front_infermier_rendezvous_index', { page: p }) }}">{{ p }}</a>
									</li>
								{% endfor %}
								<li class="page-item {{ pagination.page >= pagination.pages ? 'disabled' : '' }}">
									<a class="page-link" href="{{ path(paginationRoute ?? 'front_infermier_rendezvous_index', { page: pagination.page + 1 }) }}">Suivant</a>
								</li>
							</ul>
						</nav>
					</div>
				</section>
			{% endif %}
		</main>
	</div>
{% endblock %}

{% block javascripts %}
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const dateInput = document.getElementById('rdv-filter-date');
			const applyBtn = document.getElementById('rdv-filter-apply');
			const resetBtn = document.getElementById('rdv-filter-reset');
			const cards = document.querySelectorAll('.consult-grid .consultation-card[data-date]');

			if (!dateInput || !applyBtn || !resetBtn || !cards.length) {
				return;
			}

			const applyDateFilter = function () {
				const selectedDate = dateInput.value || '';
				cards.forEach(function (card) {
					const cardDate = card.dataset.date || '';
					card.style.display = (!selectedDate || cardDate === selectedDate) ? '' : 'none';
				});
			};

			applyBtn.addEventListener('click', applyDateFilter);
			dateInput.addEventListener('change', applyDateFilter);
			dateInput.addEventListener('keydown', function (event) {
				if (event.key === 'Enter') {
					event.preventDefault();
					applyDateFilter();
				}
			});
			resetBtn.addEventListener('click', function () {
				dateInput.value = '';
				applyDateFilter();
			});
		});
	</script>
{% endblock %}
