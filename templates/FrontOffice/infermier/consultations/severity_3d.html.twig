{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/infermier.css') }}">
    <style>
        :root {
            --sev-bg: #f4faf8;
            --sev-card: #ffffff;
            --sev-line: #d9ebe3;
            --sev-text: #123540;
            --sev-muted: #5b7a86;
            --sev-low: #1f9d6b;
            --sev-medium: #d0971a;
            --sev-high: #c0392b;
        }

        .sev-page {
            background: radial-gradient(circle at 10% 10%, #e5f7f1 0%, transparent 35%), linear-gradient(180deg, #f8fcfb 0%, #f3f8ff 100%);
            border: 1px solid var(--sev-line);
            border-radius: 14px;
            padding: 16px;
        }

        .sev-head {
            background: var(--sev-card);
            border: 1px solid var(--sev-line);
            border-radius: 12px;
            padding: 14px 16px;
        }

        .sev-title {
            margin: 0;
            color: var(--sev-text);
            font-weight: 800;
            font-size: 1.3rem;
        }

        .sev-subtitle {
            margin: 0;
            color: var(--sev-muted);
            font-size: 0.92rem;
        }

        .sev-grid {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 12px;
        }

        .sev-card {
            background: var(--sev-card);
            border: 1px solid var(--sev-line);
            border-radius: 12px;
            padding: 14px;
        }

        .sev-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 5px 12px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #fff;
        }

        .sev-low { background: var(--sev-low); }
        .sev-medium { background: var(--sev-medium); }
        .sev-high { background: var(--sev-high); }

        .sev-meter-wrap {
            margin-top: 10px;
            background: #eef6f3;
            border-radius: 999px;
            height: 16px;
            border: 1px solid #d5e6df;
            overflow: hidden;
        }

        .sev-meter {
            height: 100%;
            transition: width 0.4s ease;
            background: linear-gradient(90deg, var(--sev-low), var(--sev-medium), var(--sev-high));
        }

        .reason-list {
            margin: 10px 0 0;
            padding-left: 16px;
            color: #224857;
        }

        .reason-list li {
            margin-bottom: 6px;
        }

        .scene {
            width: 220px;
            height: 220px;
            margin: 8px auto 0;
            perspective: 800px;
        }

        .cube {
            width: 140px;
            height: 140px;
            position: relative;
            margin: 40px auto;
            transform-style: preserve-3d;
            animation: spin 11s linear infinite;
        }

        .face {
            position: absolute;
            width: 140px;
            height: 140px;
            border: 2px solid rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            text-align: center;
            padding: 8px;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.15);
        }

        .face.front  { transform: rotateY(0deg) translateZ(70px); }
        .face.back   { transform: rotateY(180deg) translateZ(70px); }
        .face.right  { transform: rotateY(90deg) translateZ(70px); }
        .face.left   { transform: rotateY(-90deg) translateZ(70px); }
        .face.top    { transform: rotateX(90deg) translateZ(70px); }
        .face.bottom { transform: rotateX(-90deg) translateZ(70px); }

        .cube.low .face { background: rgba(31, 157, 107, 0.85); }
        .cube.medium .face { background: rgba(208, 151, 26, 0.86); }
        .cube.high .face { background: rgba(192, 57, 43, 0.9); }

        .mini-grid {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .mini-card {
            border: 1px solid #d9eae3;
            border-radius: 10px;
            padding: 8px 10px;
            background: #fbfffd;
        }

        .mini-label {
            color: #5e7a86;
            font-size: 0.78rem;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .mini-value {
            color: #123540;
            font-weight: 700;
        }

        @keyframes spin {
            from { transform: rotateX(-20deg) rotateY(0deg); }
            to { transform: rotateX(-20deg) rotateY(360deg); }
        }

        @media (max-width: 900px) {
            .sev-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="nurse-app">
        {% include 'FrontOffice/infermier/_header.html.twig' %}
        <main class="nurse-main">
            <div class="sev-page">
                <div class="sev-head d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="sev-title">Etat clinique 3D - Consultation #{{ consultation.id }}</h1>
                        <p class="sev-subtitle mb-0">
                            Patient {{ consultation.patient.prenom }} {{ consultation.patient.nom }} |
                            {{ consultation.dateConsultation ? consultation.dateConsultation|date('d/m/Y') : '-' }}
                            {{ consultation.heureConsultation ? consultation.heureConsultation|date('H:i') : '' }}
                        </p>
                    </div>
                    <a class="btn btn-outline-secondary btn-sm" href="{{ path('front_infermier_consultation_index') }}">Retour consultations</a>
                </div>

                <div class="sev-grid">
                    <section class="sev-card">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Niveau de gravite</div>
                                <span class="sev-badge sev-{{ severity.level }}">{{ severity.levelLabel }}</span>
                            </div>
                            <div class="text-end">
                                <div class="text-muted small">Score</div>
                                <div class="h4 mb-0">{{ severity.score }}/100</div>
                            </div>
                        </div>

                        <div class="sev-meter-wrap">
                            <div class="sev-meter" style="width: {{ severity.score }}%;"></div>
                        </div>

                        <div class="mt-3 fw-semibold">Facteurs de gravite identifies</div>
                        <ul class="reason-list">
                            {% for reason in severity.reasons %}
                                <li>{{ reason }}</li>
                            {% endfor %}
                        </ul>

                        <div class="mini-grid">
                            <div class="mini-card">
                                <div class="mini-label">Dominante clinique</div>
                                <div class="mini-value">{{ severity.dominantLabel }}</div>
                            </div>
                            <div class="mini-card">
                                <div class="mini-label">TA</div>
                                <div class="mini-value">
                                    {{ severity.vitals.systolique is not null ? severity.vitals.systolique : '-' }}/{{ severity.vitals.diastolique is not null ? severity.vitals.diastolique : '-' }} mmHg
                                </div>
                            </div>
                            <div class="mini-card">
                                <div class="mini-label">Poids</div>
                                <div class="mini-value">{{ severity.vitals.poids is not null ? severity.vitals.poids ~ ' kg' : '-' }}</div>
                            </div>
                            <div class="mini-card">
                                <div class="mini-label">Variation poids (30j)</div>
                                <div class="mini-value">{{ severity.vitals.poidsVariation30j is not null ? severity.vitals.poidsVariation30j ~ ' kg' : '-' }}</div>
                            </div>
                        </div>
                    </section>

                    <section class="sev-card text-center">
                        <div class="text-muted small">Visualisation 3D etat patient</div>
                        <div class="scene">
                            <div class="cube {{ severity.level }}">
                                <div class="face front">Etat global<br>{{ severity.levelLabel }}</div>
                                <div class="face back">Score<br>{{ severity.score }}/100</div>
                                <div class="face right">Cardio<br>{{ severity.components.cardio }}</div>
                                <div class="face left">Metabo<br>{{ severity.components.metabolic }}</div>
                                <div class="face top">Meds<br>{{ severity.components.medication }}</div>
                                <div class="face bottom">Fragilite<br>{{ severity.components.frailty }}</div>
                            </div>
                        </div>
                        <div class="small text-muted">Rotation 3D en temps reel des dimensions cliniques.</div>
                    </section>
                </div>
            </div>
        </main>
    </div>
{% endblock %}
