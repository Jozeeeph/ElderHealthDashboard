{% extends 'base.html.twig' %}

{% block title %}Gestion des Rendez-vous{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/appointments.css') }}">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
  

{% endblock %}

{% block body %}
{% set activeTab = app.request.query.get('tab', 'rdv') %}
<div class="appointments-page">
    <div class="appointments-container">
        
        <div class="appointments-header">
            <h1>
                <i class="bi bi-calendar-check"></i>
                Gestion des Rendez-vous
            </h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="loadModal('{{ path('appointment_new') }}', 'rdvModal')">
                    <i class="bi bi-plus-circle"></i>
                    Nouveau RDV
                </button>
                <button class="btn btn-warning" onclick="loadModal('{{ path('appointment_type_new') }}', 'typeModal')">
                    <i class="bi bi-plus-circle"></i>
                    Nouveau Type
                </button>
            </div>
        </div>

       
        <div class="appointments-tabs">
            <ul class="nav nav-tabs" id="appointmentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {{ activeTab != 'types' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#rdv" role="tab">
                        <i class="bi bi-calendar-event icon-md"></i>
                        Rendez-vous
                        <span class="badge bg-primary">{{ rendezVousList|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {{ activeTab == 'types' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#types" role="tab">
                        <i class="bi bi-tags icon-md"></i>
                        Types de Rendez-vous
                        <span class="badge bg-warning">{{ typesRendezVous|length }}</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3">
                
                <div class="tab-pane fade {{ activeTab != 'types' ? 'show active' : '' }}" id="rdv" role="tabpanel">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small text-uppercase text-muted" for="rdv-filter-date">Date</label>
                                    <input id="rdv-filter-date" class="form-control" type="date">
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label small text-uppercase text-muted" for="rdv-filter-etat">Etat</label>
                                    <select id="rdv-filter-etat" class="form-select">
                                        <option value="">Tous les etats</option>
                                        <option value="EN_ATTENTE">En attente</option>
                                        <option value="PLANIFIE">Planifiee</option>
                                        <option value="EN_COURS">En cours</option>
                                        <option value="TERMINE">Terminee</option>
                                        <option value="ANNULEE">Annulee</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-auto ms-md-auto d-flex justify-content-end">
                                    <button class="btn btn-outline-primary me-2" id="rdv-filter-apply" type="button">
                                        <i class="bi bi-funnel"></i>
                                        Filtrer
                                    </button>
                                    <button class="btn btn-outline-secondary me-2" id="rdv-filter-reset" type="button">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                        Reinitialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-0">
                        <div class="card-header-appointments">
                            <h5>
                                <i class="bi bi-list-task"></i>
                                Liste des Rendez-vous
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            {% if rendezVousList is empty %}
                                <div class="empty-state">
                                    <i class="bi bi-calendar-x"></i>
                                    <h5>Aucun rendez-vous programmé</h5>
                                    <p>Commencez par ajouter un nouveau rendez-vous</p>
                                </div>
                            {% else %}
                                <div class="rdv-cards">
                                    {% for rdv in rendezVousList %}
                                        <div class="rdv-card fade-in"
                                             data-date="{{ rdv.date|date('Y-m-d') }}"
                                             data-etat="{{ rdv.etat|upper }}">
                                            <div class="rdv-main">
                                                <div class="rdv-meta">
                                                    <div class="rdv-date">
                                                        <i class="bi bi-calendar"></i>
                                                        {{ rdv.date|date('d/m/Y') }}
                                                    </div>
                                                    <div class="rdv-time">
                                                        <i class="bi bi-clock"></i>
                                                        {{ rdv.heure|date('H:i') }}
                                                    </div>
                                                    <div class="rdv-place">
                                                        <i class="bi bi-geo-alt"></i>
                                                        {{ rdv.lieu|slice(0, 40) }}{{ rdv.lieu|length > 40 ? '...' : '' }}
                                                    </div>
                                                </div>
                                                <div class="rdv-people">
                                                    <div class="rdv-personnel">
                                                        <span class="label">Personnel</span>
                                                        <span class="value">
                                                            {{ rdv.personnelMedical ? (rdv.personnelMedical.nom ~ ' ' ~ rdv.personnelMedical.prenom) : 'Non assigné' }}
                                                        </span>
                                                    </div>
                                                    <div class="rdv-patient">
                                                        <span class="label">Patient</span>
                                                        <span class="value">
                                                            {{ rdv.patient ? (rdv.patient.nom ~ ' ' ~ rdv.patient.prenom) : 'Non assigné' }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="rdv-side">
                                                <div class="rdv-type">
                                                    <span class="badge bg-info text-white">
                                                        {{ rdv.typeRendezVous.type }}
                                                    </span>
                                                </div>
                                                <div class="rdv-status">
                                                    {% set etatClass = {
                                                        'EN_ATTENTE': 'status-en_attente',
                                                        'PLANIFIE': 'status-planifiee',
                                                        'PLANIFIEE': 'status-planifiee',
                                                        'EN_COURS': 'status-en_cours',
                                                        'TERMINE': 'status-terminee',
                                                        'TERMINEE': 'status-terminee',
                                                        'ANNULEE': 'status-annulee'
                                                    } %}
                                                    <span class="status-badge {{ etatClass[rdv.etat] ?? 'status-planifiee' }}">
                                                        {{ rdv.etat|replace({'_': ' '})|lower|title }}
                                                    </span>
                                                </div>
                                                <div class="rdv-actions">
                                                    <button class="btn-action edit"
                                                            onclick="loadModal('{{ path('appointment_edit', {'id': rdv.id}) }}', 'rdvModal')"
                                                            title="Modifier">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <a class="btn-action delete js-delete"
                                                       href="{{ path('appointment_delete', {'id': rdv.id}) }}"
                                                       data-delete-url="{{ path('appointment_delete', {'id': rdv.id}) }}"
                                                       data-delete-name="{{ rdv.patient ? (rdv.patient.prenom ~ ' ' ~ rdv.patient.nom) : '' }}"
                                                       data-delete-token="{{ csrf_token('delete_rdv_' ~ rdv.id) }}"
                                                       data-entity="rendez-vous"
                                                       title="Supprimer">
                                                        <i class="bi bi-trash"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if rdvPagination.pages > 1 %}
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-3">
                            <div class="text-muted small">
                                Page {{ rdvPagination.page }} / {{ rdvPagination.pages }} - {{ rdvPagination.total }} rendez-vous
                            </div>
                            <nav aria-label="Pagination rendez-vous">
                                <ul class="pagination mb-0">
                                    <li class="page-item {{ rdvPagination.page <= 1 ? 'disabled' : '' }}">
                                        <a class="page-link" href="{{ path('appointment_index', { page: rdvPagination.page - 1 }) }}">Precedent</a>
                                    </li>
                                    {% for p in 1..rdvPagination.pages %}
                                        <li class="page-item {{ p == rdvPagination.page ? 'active' : '' }}">
                                            <a class="page-link" href="{{ path('appointment_index', { page: p }) }}">{{ p }}</a>
                                        </li>
                                    {% endfor %}
                                    <li class="page-item {{ rdvPagination.page >= rdvPagination.pages ? 'disabled' : '' }}">
                                        <a class="page-link" href="{{ path('appointment_index', { page: rdvPagination.page + 1 }) }}">Suivant</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    {% endif %}
                </div>

               
                <div class="tab-pane fade {{ activeTab == 'types' ? 'show active' : '' }}" id="types" role="tabpanel">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-12 col-md-6">
                                    <label class="form-label small text-uppercase text-muted" for="type-filter-text">Type</label>
                                    <input id="type-filter-text" class="form-control" type="text" placeholder="Rechercher un type">
                                </div>
                                <div class="col-12 col-md-auto ms-md-auto d-flex justify-content-end">
                                    <a class="btn btn-outline-primary me-2" href="{{ path('appointment_index', { tab: 'rdv' }) }}">
                                        <i class="bi bi-arrow-left"></i>
                                        Retour
                                    </a>
                                    <button class="btn btn-outline-warning me-2" id="type-filter-apply" type="button">
                                        <i class="bi bi-funnel"></i>
                                        Filtrer
                                    </button>
                                    <button class="btn btn-outline-secondary me-2" id="type-filter-reset" type="button">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                        Reinitialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-0">
                        <div class="card-header-appointments">
                            <h5>
                                <i class="bi bi-tags"></i>
                                Types de Rendez-vous
                            </h5>
                            <a class="btn btn-outline-primary" href="{{ path('appointment_index', { tab: 'rdv' }) }}">
                                <i class="bi bi-arrow-left"></i>
                                Retour
                            </a>
                        </div>
                        <div class="card-body p-0">
                            {% if typesRendezVous is empty %}
                                <div class="empty-state">
                                    <i class="bi bi-tag"></i>
                                    <h5>Aucun type défini</h5>
                                    <p>Commencez par ajouter un type de rendez-vous</p>
                                </div>
                            {% else %}
                                <div class="type-cards">
                                    {% for type in typesRendezVous %}
                                        <div class="type-card fade-in" data-type="{{ type.type|lower }}">
                                            <div class="type-main">
                                                <div class="type-title">
                                                    <i class="bi bi-tag-fill"></i>
                                                    {{ type.type }}
                                                </div>
                                                <div class="type-meta">
                                                    <span class="type-chip">
                                                        <i class="bi bi-currency-euro"></i>
                                                        {{ type.Tarif }} DT
                                                    </span>
                                                    <span class="type-chip">
                                                        <i class="bi bi-clock"></i>
                                                        {{ type.duree }} min
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="type-actions">
                                                <button class="btn-action edit"
                                                        onclick="loadModal('{{ path('appointment_type_edit', {'id': type.id}) }}', 'typeModal')"
                                                        title="Modifier">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <a class="btn-action delete js-delete"
                                                   href="{{ path('appointment_type_delete', {'id': type.id}) }}"
                                                   data-delete-url="{{ path('appointment_type_delete', {'id': type.id}) }}"
                                                   data-delete-name="{{ type.type }}"
                                                   data-delete-token="{{ csrf_token('delete_type_rdv_' ~ type.id) }}"
                                                   data-entity="type de rendez-vous"
                                                   title="Supprimer">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="rdvModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
       
    </div>
</div>

<div class="modal fade" id="typeModal" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered">
        
    </div>
</div>


<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content delete-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Confirmation de suppression
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Voulez-vous vraiment supprimer cet élément ?</p>
                <div class="fw-semibold" data-delete-name></div>
                <div class="alert alert-warning">
                    Cette action est définitive.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteConfirmForm" method="post" action="" class="m-0">
                    <input type="hidden" name="_token" value="">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i>
                        Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% for message in app.flashes('success') %}
    <div class="alert alert-success alert-dismissible fade show flash-alert" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endfor %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ asset('js/sb-admin-2.min.js') }}"></script>
    
    <script>
        function loadModal(url, modalId) {
            $.ajax({
                url: url,
                method: 'GET',
                beforeSend: function() {
                    
                    $('#' + modalId + ' .modal-dialog').html(`
                        <div class="modal-content">
                            <div class="modal-body text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-3">Chargement en cours...</p>
                            </div>
                        </div>
                    `);
                },
                success: function(data) {
                    $('#' + modalId + ' .modal-dialog').html(data);
                    var modal = new bootstrap.Modal(document.getElementById(modalId));
                    modal.show();
                    
                    
                    $('#' + modalId + ' .modal-content').addClass('modal-appointment');
                    
                   
                    $('#' + modalId + ' form').on('submit', function(e) {
                        e.preventDefault();
                        var form = $(this);
                        if (!validateAppointmentForm(form)) {
                            return;
                        }
                        var submitBtn = form.find('button[type="submit"]');
                        var submitLabel = submitBtn.data('default-label') || $.trim(submitBtn.text()) || 'Ajouter';
                        
                       
                        submitBtn.prop('disabled', true).html(`
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            Enregistrement...
                        `);
                        
                        $.ajax({
                            url: form.attr('action') || url,
                            method: 'POST',
                            data: form.serialize(),
                            success: function(response) {
                                if ($(response).find('.invalid-feedback').length === 0 && 
                                    $(response).find('.is-invalid').length === 0) {
                                    var redirectToTypes = form.attr('id') === 'typeForm';
                                    if (redirectToTypes) {
                                        window.location.href = "{{ path('appointment_index', { tab: 'types' }) }}";
                                    } else {
                                        window.location.href = "{{ path('appointment_index') }}";
                                    }
                                } else {
                                   
                                    $('#' + modalId + ' .modal-dialog').html(response);
                                    $('#' + modalId + ' .modal-content').addClass('modal-appointment');
                                    
                                    submitBtn.prop('disabled', false).html(submitLabel);
                                }
                            },
                            error: function() {
                                submitBtn.prop('disabled', false).html(submitLabel);
                                alert('Une erreur est survenue. Veuillez réessayer.');
                            }
                        });
                    });
                },
                error: function() {
                    $('#' + modalId + ' .modal-dialog').html(`
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">Erreur</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-danger">
                                    Impossible de charger le formulaire. Veuillez réessayer.
                                </div>
                            </div>
                        </div>
                    `);
                    var modal = new bootstrap.Modal(document.getElementById(modalId));
                    modal.show();
                }
            });
        }
        
        $(document).ready(function() {
           
            $('.fade-in').each(function(i) {
                $(this).css('animation-delay', (i * 0.05) + 's');
            });
            

            function applyRdvFilters() {
                var dateVal = $('#rdv-filter-date').val() || '';
                var etatVal = ($('#rdv-filter-etat').val() || '').toUpperCase();

                $('#rdv .rdv-card').each(function() {
                    var card = $(this);
                    var rowDate = (card.data('date') || '').toString();
                    var rowEtat = (card.data('etat') || '').toString().toUpperCase();

                    var matchDate = !dateVal || rowDate === dateVal;
                    var matchEtat = !etatVal || rowEtat === etatVal;

                    card.toggle(matchDate && matchEtat);
                });
            }

            function applyTypeFilters() {
                var typeVal = ($('#type-filter-text').val() || '').toLowerCase().trim();
                $('#types .type-card').each(function() {
                    var card = $(this);
                    var rowType = (card.data('type') || '').toString();
                    var matchType = !typeVal || rowType.indexOf(typeVal) !== -1;
                    card.toggle(matchType);
                });
            }

            $('#rdv-filter-apply').on('click', applyRdvFilters);
            $('#type-filter-apply').on('click', applyTypeFilters);

            $('#rdv-filter-reset').on('click', function() {
                $('#rdv-filter-date').val('');
                $('#rdv-filter-etat').val('');
                applyRdvFilters();
            });

            $('#type-filter-reset').on('click', function() {
                $('#type-filter-text').val('');
                applyTypeFilters();
            });

            $('#rdv-filter-date, #rdv-filter-etat').on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyRdvFilters();
                }
            });
            $('#type-filter-text').on('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyTypeFilters();
                }
            });
            
            $(document).on('click', '.js-delete', function(e) {
                e.preventDefault();
                var url = $(this).data('delete-url');
                var entity = $(this).data('entity') || 'élément';
                var name = $(this).data('delete-name') || '';
                var token = $(this).data('delete-token') || '';

                $('#deleteConfirmMessage').text('Voulez-vous vraiment supprimer ce ' + entity + ' ?');
                var nameEl = $('#deleteConfirmModal').find('[data-delete-name]');
                if (name) {
                    nameEl.text(name).show();
                } else {
                    nameEl.text('').hide();
                }
                $('#deleteConfirmForm').attr('action', url);
                $('#deleteConfirmForm').find('input[name="_token"]').val(token);

                var modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                modal.show();
            });
            console.log("Gestion des rendez-vous - Interface chargée");
        });

        function clearValidation(form) {
            form.find('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
            form.find('.invalid-feedback.dynamic').remove();
        }

        function setFieldError(field, message) {
            field.addClass('is-invalid');
            var feedback = $('<div class="invalid-feedback dynamic"></div>').text(message);
            field.closest('.mb-3, .col-md-6, .col-md-12, .col-12').append(feedback);
        }

        function setFieldValid(field) {
            field.addClass('is-valid');
        }

        function validateAppointmentForm(form) {
            clearValidation(form);

            var isRdv = form.attr('id') === 'rdvForm';
            var isType = form.attr('id') === 'typeForm';
            var valid = true;

            if (isRdv) {
                var dateField = form.find('input[name$="[date]"]');
                var heureField = form.find('input[name$="[heure]"]');
                var lieuField = form.find('input[name$="[lieu]"]');
                var typeField = form.find('select[name$="[typeRendezVous]"]');

                if (!dateField.val()) {
                    setFieldError(dateField, 'La date est obligatoire.');
                    valid = false;
                } else {
                    setFieldValid(dateField);
                }

                if (!heureField.val()) {
                    setFieldError(heureField, 'L heure est obligatoire.');
                    valid = false;
                } else {
                    setFieldValid(heureField);
                }

                var lieuVal = (lieuField.val() || '').trim();
                if (!lieuVal) {
                    setFieldError(lieuField, 'Le lieu est obligatoire.');
                    valid = false;
                } else if (lieuVal.length < 2 || lieuVal.length > 255) {
                    setFieldError(lieuField, 'Le lieu doit contenir entre 2 et 255 caracteres.');
                    valid = false;
                } else {
                    setFieldValid(lieuField);
                }

                if (!typeField.val()) {
                    setFieldError(typeField, 'Le type de rendez-vous est obligatoire.');
                    valid = false;
                } else {
                    setFieldValid(typeField);
                }
            }

            if (isType) {
                var typeText = form.find('input[name$="[type]"]');
                var tarifField = form.find('input[name$="[tarif]"]');
                var dureeField = form.find('input[name$="[duree]"]');

                var typeVal = (typeText.val() || '').trim();
                if (!typeVal) {
                    setFieldError(typeText, 'Le type est obligatoire.');
                    valid = false;
                } else if (typeVal.length < 2 || typeVal.length > 200) {
                    setFieldError(typeText, 'Le type doit contenir entre 2 et 200 caracteres.');
                    valid = false;
                } else {
                    setFieldValid(typeText);
                }

                var tarifVal = (tarifField.val() || '').trim();
                if (!tarifVal) {
                    setFieldError(tarifField, 'Le tarif est obligatoire.');
                    valid = false;
                } else if (isNaN(tarifVal)) {
                    setFieldError(tarifField, 'Le tarif doit etre numerique.');
                    valid = false;
                } else if (Number(tarifVal) < 0 || Number(tarifVal) > 10000) {
                    setFieldError(tarifField, 'Le tarif doit etre entre 0 et 10000.');
                    valid = false;
                } else {
                    setFieldValid(tarifField);
                }

                var dureeVal = (dureeField.val() || '').trim();
                if (!dureeVal) {
                    setFieldError(dureeField, 'La duree est obligatoire.');
                    valid = false;
                } else {
                    setFieldValid(dureeField);
                }
            }

            return valid;
        }
    </script>
{% endblock %}















