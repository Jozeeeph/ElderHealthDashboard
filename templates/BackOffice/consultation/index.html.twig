{% extends 'base.html.twig' %}

{% block title %}Liste des Consultations{% endblock %}

{% block body %}
<style>
.consultation-page {
    --ink: #1e2a2f;
    --muted: #6c7a80;
    --brand: #0e8aa7;
    --brand-2: #2bbf9f;
    --bg: #f4f7f8;
    --card: #ffffff;
    --ring: rgba(14, 138, 167, 0.2);
}

.consultation-header {
    background: linear-gradient(135deg, #fff4e6 0%, #eef6ff 55%, #f3fff6 100%);
    border-radius: 18px 28px 18px 28px;
    padding: 18px 20px;
    border: 1px solid #f0e2d5;
}

.consultation-title {
    color: var(--ink);
    letter-spacing: 0.2px;
    font-size: 1.65rem;
    font-weight: 800;
}

.consultation-subtitle {
    color: var(--muted);
    font-size: 0.95rem;
}

.consultation-btn {
    background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
    border: none;
    box-shadow: 0 8px 18px rgba(14, 138, 167, 0.25);
}

.consultation-btn:hover {
    filter: brightness(0.98);
}

.consultation-card {
    border: 1px solid #e6edf0;
    border-radius: 18px 28px 18px 28px;
    background: var(--card);
    transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
    overflow: hidden;
}

.consultation-card:hover {
    transform: translateY(-2px);
    border-color: #d6e4ea;
    box-shadow: 0 10px 28px rgba(30, 42, 47, 0.12);
}

.consultation-card:focus-within {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
}

.consultation-accent {
    height: 6px;
    border-radius: 18px 28px 0 0;
    margin: -1px -1px 12px -1px;
}

.consultation-card[data-status^="planif"] .consultation-accent {
    background: linear-gradient(90deg, #2b9de2, #69c1f2);
}

.consultation-card[data-status^="réal"] .consultation-accent,
.consultation-card[data-status^="real"] .consultation-accent {
    background: linear-gradient(90deg, #27b07f, #7bd6b1);
}

.consultation-card[data-status^="en_cours"] .consultation-accent,
.consultation-card[data-status^="en cours"] .consultation-accent {
    background: linear-gradient(90deg, #f4b740, #f8d27a);
}

.consultation-card[data-status^="term"] .consultation-accent {
    background: linear-gradient(90deg, #2bbf9f, #6edfbf);
}

.consultation-card[data-status^="annul"] .consultation-accent {
    background: linear-gradient(90deg, #e05858, #f2a0a0);
}

.consultation-label {
    color: var(--muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.consultation-name {
    font-weight: 800;
    font-size: 1.05rem;
    color: var(--ink);
}

.badge-soft {
    background: #eef6f8;
    color: #1a5b6b;
    border: 1px solid #d6e7ec;
}

.consultation-modal .modal-content {
    border: none;
    border-radius: 20px 28px 20px 28px;
    box-shadow: 0 18px 48px rgba(30, 42, 47, 0.2);
    background: #ffffff;
}

.consultation-modal .modal-header {
    border: 0;
    background: linear-gradient(135deg, #e8f6f9 0%, #eef8f4 100%);
    border-radius: 20px 28px 0 0;
    padding: 16px 20px;
}

.consultation-modal .modal-title {
    font-weight: 700;
    color: #1e2a2f;
}

.consultation-modal .modal-body {
    padding: 18px 20px 22px;
    background: #ffffff;
}

.consultation-grid {
    display: grid;
    gap: 10px;
}

.consultation-row {
    display: grid;
    grid-template-columns: 110px 1fr;
    gap: 10px;
    align-items: center;
}

.consultation-row .value {
    color: var(--ink);
    font-weight: 700;
}

.consultation-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.consultation-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 999px;
    background: #eef6f8;
    border: 1px solid #d6e7ec;
    color: #1a5b6b;
    font-size: 0.85rem;
    font-weight: 600;
}

.consultation-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 8px;
    margin-top: 12px;
}

.consultation-actions .btn {
    border-radius: 999px;
    padding: 7px 12px;
    font-weight: 700;
}

.consultation-toast {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1080;
}
</style>

<div class="consultation-page">
<div class="consultation-header d-flex align-items-center justify-content-between mb-3">
    <div>
        <h1 class="consultation-title mb-1">🩺 Liste des Consultations</h1>
        <div class="consultation-subtitle">Vue rapide des rendez-vous et statuts</div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" href="{{ path('consultation_archives') }}">
            <i class="bi bi-archive me-1"></i>
            Archives
        </a>
        <button type="button"
                class="btn btn-primary consultation-btn"
                data-bs-toggle="modal"
                data-bs-target="#consultationNewModal"
                data-new-url="{{ path('consultation_new') }}">
            ➕ Nouvelle Consultation
        </button>
    </div>
</div>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
        <form method="get" action="{{ path('consultation_index') }}">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label small text-uppercase text-muted" for="filter-patient">🧑‍🦳 Patient</label>
                    <input id="filter-patient" name="patient" class="form-control" type="text"
                           value="{{ filters.patient ?? '' }}" placeholder="Nom ou prénom du patient">
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label small text-uppercase text-muted" for="filter-personnel">👨‍⚕️ Personnel médical</label>
                    <input id="filter-personnel" name="personnel" class="form-control" type="text"
                           value="{{ filters.personnel ?? '' }}" placeholder="Nom ou prénom du personnel">
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label small text-uppercase text-muted" for="filter-date">📅 Date consultation</label>
                    <input id="filter-date" name="date" class="form-control" type="date"
                           value="{{ filters.date ?? '' }}">
                </div>
                <div class="col-12 col-md-auto ms-md-auto d-flex justify-content-end">
                    <button class="btn btn-primary px-4" type="submit">
                        <i class="bi bi-search"></i>
                        Filtrer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row g-3">
    {% for consultation in consultations %}
        {% set status = consultation.etatConsultation ? consultation.etatConsultation|lower : '' %}
        {% set status_label = status == 'en_cours' ? 'En cours'
            : (status == 'terminee' or status == 'terminée' ? 'Terminée'
            : (status == 'planifiée' ? 'Planifiée'
            : (status == 'réalisée' ? 'Réalisée'
            : (status == 'annulée' ? 'Annulée' : (consultation.etatConsultation ?? ''))))) %}

        <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm position-relative consultation-card"
                 data-status="{{ status }}">
                <div class="card-body">
                    <div class="consultation-accent"></div>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="consultation-label">🧑‍🦳 Patient</div>
                            <div class="consultation-name">
                                {{ consultation.patient.prenom }} {{ consultation.patient.nom }}
                            </div>
                        </div>
                        <span class="badge badge-soft">{{ status_label }}</span>
                    </div>

                    <div class="consultation-meta">
                        <span class="consultation-chip">📅 {{ consultation.dateConsultation ? consultation.dateConsultation|date('d/m/Y') : '-' }}</span>
                        <span class="consultation-chip">⏰ {{ consultation.heureConsultation ? consultation.heureConsultation|date('H:i') : '-' }}</span>
                        {% if consultation.lieu %}
                            <span class="consultation-chip">📍 {{ consultation.lieu }}</span>
                        {% endif %}
                    </div>

                    <div class="consultation-grid">
                        <div class="consultation-row">
                            <div class="consultation-label">👨‍⚕️ Personnel</div>
                            <div class="value">
                                {{ consultation.personnelMedical.prenom }} {{ consultation.personnelMedical.nom }}
                            </div>
                        </div>
                        <div class="consultation-row">
                            <div class="consultation-label">🧾 Créée par</div>
                            <div class="value">
                                {% if consultation.createdBy %}
                                    {{ consultation.createdBy.prenom }} {{ consultation.createdBy.nom }}
                                    <span class="text-muted">•</span>
                                    {{ consultation.createdRole ?? (consultation.createdBy.role ? consultation.createdBy.role.value : '-') }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="consultation-actions">
                        <button type="button"
                                class="btn btn-warning btn-sm js-edit-consultation"
                                data-bs-toggle="modal"
                                data-bs-target="#consultationEditModal"
                                data-edit-url="{{ path('consultation_edit', {'id': consultation.id}) }}">
                            ✏️ 
                        </button>
                        <button type="button"
                                class="btn btn-danger btn-sm js-delete-consultation"
                                data-delete-url="{{ path('consultation_delete', {'id': consultation.id}) }}"
                                data-delete-name="{{ consultation.patient.prenom }} {{ consultation.patient.nom }}"
                                data-delete-token="{{ csrf_token('delete_consultation_' ~ consultation.id) }}">
                            🗑️ 
                        </button>
                        {% if consultation.rapportMedical %}
                            <a class="btn btn-outline-primary btn-sm"
                               href="{{ path('rapport_medical_show', {'id': consultation.rapportMedical.idRapport}) }}">
                                🧾 rapport
                            </a>
                            <a class="btn btn-outline-secondary btn-sm"
                               href="{{ path('rapport_medical_pdf', {'id': consultation.rapportMedical.idRapport}) }}">
                                📄 PDF rapport
                            </a>
                        {% else %}
                            <button type="button"
                                    class="btn btn-success btn-sm js-rapport-new"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rapportNewModal"
                                    data-new-url="{{ path('rapport_medical_new', {'id': consultation.id}) }}">
                                ➕ Ajouter rapport
                            </button>
                        {% endif %}

                        {% if consultation.prescription %}
                            <a class="btn btn-outline-primary btn-sm"
                               href="{{ path('prescription_show', {'id': consultation.prescription.idPrescription}) }}">
                                💊 Prescription
                            </a>
                            <a class="btn btn-outline-secondary btn-sm"
                               href="{{ path('prescription_pdf', {'id': consultation.prescription.idPrescription}) }}">
                                📄💊 PDF prescription
                            </a>
                        {% else %}
                            <button type="button"
                                    class="btn btn-success btn-sm js-prescription-new"
                                    data-bs-toggle="modal"
                                    data-bs-target="#prescriptionNewModal"
                                    data-new-url="{{ path('prescription_new', {'id': consultation.id}) }}">
                                ➕ Ajouter prescription
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="col-12">
            <div class="alert alert-info mb-0">Aucune consultation.</div>
        </div>
    {% endfor %}
</div>
</div>

<div class="consultation-toast toast-container">
    <div id="consultationErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">Une erreur est survenue.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="consultationEditModal" tabindex="-1" aria-labelledby="consultationEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationEditModalLabel">Modifier Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="consultationNewModal" tabindex="-1" aria-labelledby="consultationNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationNewModalLabel">Nouvelle Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="rapportNewModal" tabindex="-1" aria-labelledby="rapportNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rapportNewModalLabel">Nouveau rapport medical</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="prescriptionNewModal" tabindex="-1" aria-labelledby="prescriptionNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prescriptionNewModalLabel">Nouvelle prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="consultationDeleteModal" tabindex="-1" aria-labelledby="consultationDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationDeleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">Voulez-vous vraiment supprimer cette consultation ?</div>
                <div class="fw-semibold" data-delete-name></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                <form method="post" action="">
                    <input type="hidden" name="_token" value="">
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const editModal = document.getElementById('consultationEditModal');
    const newModal = document.getElementById('consultationNewModal');
    const rapportNewModal = document.getElementById('rapportNewModal');
    const prescriptionNewModal = document.getElementById('prescriptionNewModal');
    const deleteModal = document.getElementById('consultationDeleteModal');
    const errorToastEl = document.getElementById('consultationErrorToast');
    const errorToast = errorToastEl ? bootstrap.Toast.getOrCreateInstance(errorToastEl, { delay: 4000 }) : null;
    if (!editModal && !newModal && !rapportNewModal && !prescriptionNewModal && !deleteModal) return;

    const showErrorToast = (message) => {
        if (!errorToastEl || !errorToast) return;
        const body = errorToastEl.querySelector('.toast-body');
        if (body) {
            body.textContent = message;
        }
        errorToast.show();
    };

    const bindFormSubmit = (modal) => {
        const modalBody = modal.querySelector('.modal-body');
        if (!modalBody) return;
        const form = modalBody.querySelector('form');
        if (!form) return;

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: form.method || 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                if (!response.ok) {
                    throw new Error("Impossible d'envoyer le formulaire.");
                }

                const html = await response.text();
                modalBody.innerHTML = html;
                bindFormSubmit(modal);
            } catch (e) {
                showErrorToast(e.message || 'Erreur lors de l\'envoi.');
            }
        });
    };

    const loadFormIntoModal = async (modal, url) => {
        const modalBody = modal.querySelector('.modal-body');
        if (!modalBody) return;
        modalBody.innerHTML = '<div class="text-muted small">Chargement...</div>';
        try {
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) {
                throw new Error('Impossible de charger le formulaire.');
            }
            const html = await response.text();
            modalBody.innerHTML = html;
            bindFormSubmit(modal);
        } catch (e) {
            modalBody.innerHTML = '<div class="alert alert-danger mb-0">Impossible de charger le formulaire.</div>';
            showErrorToast(e.message || 'Erreur de chargement.');
        }
    };

    if (editModal) {
        editModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const editUrl = trigger.getAttribute('data-edit-url');
            if (!editUrl) return;
            await loadFormIntoModal(editModal, editUrl);
        });
    }

    if (newModal) {
        newModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const newUrl = trigger.getAttribute('data-new-url');
            if (!newUrl) return;
            await loadFormIntoModal(newModal, newUrl);
        });
    }

    if (rapportNewModal) {
        rapportNewModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const newUrl = trigger.getAttribute('data-new-url');
            if (!newUrl) return;
            await loadFormIntoModal(rapportNewModal, newUrl);
        });
    }

    if (prescriptionNewModal) {
        prescriptionNewModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const newUrl = trigger.getAttribute('data-new-url');
            if (!newUrl) return;
            await loadFormIntoModal(prescriptionNewModal, newUrl);
        });
    }

    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const deleteUrl = trigger.getAttribute('data-delete-url');
            const deleteToken = trigger.getAttribute('data-delete-token');
            const deleteName = trigger.getAttribute('data-delete-name');
            const form = deleteModal.querySelector('form');
            const tokenInput = deleteModal.querySelector('input[name="_token"]');
            const nameLabel = deleteModal.querySelector('[data-delete-name]');
            if (form && deleteUrl) {
                form.setAttribute('action', deleteUrl);
            }
            if (tokenInput && deleteToken) {
                tokenInput.value = deleteToken;
            }
            if (nameLabel) {
                nameLabel.textContent = deleteName || '';
            }
        });
    }

    document.querySelectorAll('.js-delete-consultation').forEach((button) => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const modal = new bootstrap.Modal(deleteModal);
            modal.show(button);
        });
    });
});
</script>
{% endblock %}
