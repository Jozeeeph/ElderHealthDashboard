{% extends 'base.html.twig' %}

{% block title %}Liste des Consultations{% endblock %}

{% block body %}
{% set consultation_index_route = consultation_index_route|default('consultation_index') %}
{% set consultation_archives_route = consultation_archives_route|default('consultation_archives') %}
<style>
.consultation-page {
    background: #f8fafc;
    border-radius: 14px;
    padding: 14px;
}

.consultation-header {
    background: #ffffff;
    border-radius: 12px;
    padding: 16px 18px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
}

.consultation-title {
    color: #0f172a;
    font-size: 1.4rem;
    font-weight: 700;
}

.consultation-subtitle {
    color: #64748b;
    font-size: 0.9rem;
}

.consultation-btn {
    border-radius: 8px;
}

.consultation-card {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    background: #ffffff;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
    overflow: hidden;
    position: relative;
}

.consultation-card:hover {
    border-color: #cbd5e1;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
}

.consultation-accent {
    height: 4px;
    border-radius: 12px 12px 0 0;
    margin: -1px -1px 10px -1px;
    background: #cbd5e1;
}

.consultation-label {
    color: #64748b;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.consultation-name {
    font-weight: 700;
    font-size: 1rem;
    color: #0f172a;
}

.consultation-person-name {
    color: #1d4ed8;
}

.consultation-staff-name {
    color: #0f766e;
}

.badge-soft {
    background: #f1f5f9;
    color: #1e293b;
    border: 1px solid #e2e8f0;
    border-radius: 999px;
    padding: 6px 10px;
    font-weight: 600;
}

.consultation-modal .modal-content {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
    background: #ffffff;
}

.consultation-modal .modal-header {
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    border-radius: 12px 12px 0 0;
    padding: 14px 18px;
}

.consultation-modal .modal-title {
    font-weight: 600;
    color: #0f172a;
}

.consultation-modal .modal-body {
    padding: 16px 18px 18px;
    background: #ffffff;
}

.consultation-grid {
    display: grid;
    gap: 10px;
}

.consultation-row {
    display: grid;
    grid-template-columns: 110px 1fr;
    gap: 10px;
    align-items: center;
}

.consultation-row .value {
    color: #0f172a;
    font-weight: 600;
}

.consultation-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.consultation-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 999px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    color: #334155;
    font-size: 0.82rem;
    font-weight: 500;
}

.consultation-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(96px, 1fr));
    gap: 8px;
    margin-top: 12px;
}

.consultation-actions .btn {
    border-radius: 8px;
    padding: 5px 8px;
    font-weight: 500;
    font-size: 0.82rem;
    border: 1px solid #e2e8f0;
    background: #ffffff;
    color: #1e293b;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    white-space: nowrap;
}

.consultation-actions .btn:hover {
    background: #f8fafc;
}

.consultation-toast {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1080;
}

.consultation-empty-state {
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    min-height: 240px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 32px 16px;
}

.consultation-empty-state i {
    font-size: 2.75rem;
    color: #b8c4d4;
    margin-bottom: 10px;
}

.consultation-empty-state h5 {
    color: #0d3b6f;
    font-weight: 700;
    margin-bottom: 8px;
}

.consultation-empty-state p {
    color: #516784;
    margin-bottom: 0;
}
</style>

<div class="consultation-page">
{% for message in app.flashes('success') %}
    <div class="alert alert-success alert-dismissible fade show js-auto-dismiss-alert" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
{% endfor %}

{% for message in app.flashes('error') %}
    <div class="alert alert-danger alert-dismissible fade show js-auto-dismiss-alert" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
{% endfor %}

<div class="consultation-header d-flex align-items-center justify-content-between mb-3">
    <div>
        <h1 class="consultation-title mb-1">🩺 Liste des consultations</h1>
        <div class="consultation-subtitle">Vue rapide des rendez-vous et statuts</div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" href="{{ path(consultation_archives_route) }}">
            <i class="bi bi-archive me-1"></i>
            Archives
        </a>
        <button type="button"
                class="btn btn-primary consultation-btn"
                data-bs-toggle="modal"
                data-bs-target="#consultationNewModal"
                data-new-url="{{ path('consultation_new') }}">
            ➕ Nouvelle consultation
        </button>
    </div>
</div>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
        <form method="get" action="{{ path(consultation_index_route) }}">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label small text-uppercase text-muted" for="filter-patient">Patient</label>
                    <input id="filter-patient" name="patient" class="form-control" type="text"
                           value="{{ filters.patient ?? '' }}" placeholder="Nom ou prénom du patient">
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label small text-uppercase text-muted" for="filter-personnel">Personnel medical</label>
                    <input id="filter-personnel" name="personnel" class="form-control" type="text"
                           value="{{ filters.personnel ?? '' }}" placeholder="Nom ou prénom du personnel">
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label small text-uppercase text-muted" for="filter-date">Date consultation</label>
                    <input id="filter-date" name="date" class="form-control" type="date"
                           value="{{ filters.date ?? '' }}">
                </div>
                <div class="col-12 col-md-auto ms-md-auto d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-primary px-4" type="submit">
                        <i class="bi bi-funnel"></i>
                        Filtrer
                    </button>
                    <a class="btn btn-outline-secondary px-4" href="{{ path(consultation_index_route) }}">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        Retour
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row g-3">
    {% for consultation in consultations %}
        {% set status = consultation.etatConsultation ? consultation.etatConsultation|lower : '' %}
        {% set status_label = status == 'en_cours' ? 'En cours'
            : (status == 'terminee' or status == 'terminée' ? 'Terminée'
            : (status == 'planifiée' ? 'Planifiée'
            : (status == 'réalisée' ? 'Réalisée'
            : (status == 'annulée' ? 'Annulée' : (consultation.etatConsultation ?? ''))))) %}

        <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm position-relative consultation-card"
                 data-status="{{ status }}">
                <div class="card-body">
                    <div class="consultation-accent"></div>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="consultation-label">Patient</div>
                            <div class="consultation-name">
                                <span class="consultation-person-name">{{ consultation.patient.prenom }} {{ consultation.patient.nom }}</span>
                            </div>
                        </div>
                        <span class="badge badge-soft">{{ status_label }}</span>
                    </div>

                    <div class="consultation-meta">
                        <span class="consultation-chip">Date: {{ consultation.dateConsultation ? consultation.dateConsultation|date('d/m/Y') : '-' }}</span>
                        <span class="consultation-chip">Heure: {{ consultation.heureConsultation ? consultation.heureConsultation|date('H:i') : '-' }}</span>
                        {% if consultation.lieu %}
                            <span class="consultation-chip">Lieu: {{ consultation.lieu }}</span>
                        {% endif %}
                    </div>

                    <div class="consultation-grid">
                        <div class="consultation-row">
                            <div class="consultation-label">Personnel medical</div>
                            <div class="value">
                                <span class="consultation-staff-name">{{ consultation.personnelMedical.prenom }} {{ consultation.personnelMedical.nom }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="consultation-actions">
                            <button type="button"
                                class="btn btn-warning btn-sm js-edit-consultation"
                                data-bs-toggle="modal"
                                data-bs-target="#consultationEditModal"
                                data-edit-url="{{ path('consultation_edit', {'id': consultation.id}) }}">
                            ✏️ Modifier
                        </button>
                        <button type="button"
                                class="btn btn-danger btn-sm js-delete-consultation"
                                data-delete-url="{{ path('consultation_delete', {'id': consultation.id}) }}"
                                data-delete-name="{{ consultation.patient.prenom }} {{ consultation.patient.nom }}"
                                data-delete-token="{{ csrf_token('delete_consultation_' ~ consultation.id) }}">
                            🗑️ Supprimer
                        </button>
                        {% if consultation.rapportMedical %}
                            <a class="btn btn-outline-primary btn-sm"
                               href="{{ path('rapport_medical_show', {'id': consultation.rapportMedical.idRapport}) }}">
                                📄 Rapport
                            </a>
                        {% else %}
                            <button type="button"
                                    class="btn btn-success btn-sm js-rapport-new"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rapportNewModal"
                                    data-new-url="{{ path('rapport_medical_new', {'id': consultation.id}) }}">
                                ➕ Rapport
                            </button>
                        {% endif %}

                        {% if consultation.prescription %}
                            <a class="btn btn-outline-primary btn-sm"
                               href="{{ path('prescription_show', {'id': consultation.prescription.idPrescription}) }}">
                                💊 Prescription
                            </a>
                        {% else %}
                            <button type="button"
                                    class="btn btn-success btn-sm js-prescription-new"
                                    data-bs-toggle="modal"
                                    data-bs-target="#prescriptionNewModal"
                                    data-new-url="{{ path('prescription_new', {'id': consultation.id}) }}">
                                ➕ Prescription
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="col-12">
            <div class="consultation-empty-state">
                <i class="bi bi-calendar-x"></i>
                <h5>Aucune consultation programmée</h5>
                <p>Commencez par ajouter une nouvelle consultation</p>
            </div>
        </div>
    {% endfor %}
</div>

{% if pagination.pages > 1 %}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-4">
        <div class="text-muted small">
            Page {{ pagination.page }} / {{ pagination.pages }} - {{ pagination.total }} consultation(s)
        </div>
        <nav aria-label="Pagination consultations">
            <ul class="pagination mb-0">
                <li class="page-item {{ pagination.page <= 1 ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path(consultation_index_route, {
                        patient: filters.patient ?? '',
                        personnel: filters.personnel ?? '',
                        date: filters.date ?? '',
                        page: pagination.page - 1
                    }) }}">Precedent</a>
                </li>
                {% for p in 1..pagination.pages %}
                    <li class="page-item {{ p == pagination.page ? 'active' : '' }}">
                        <a class="page-link" href="{{ path(consultation_index_route, {
                            patient: filters.patient ?? '',
                            personnel: filters.personnel ?? '',
                            date: filters.date ?? '',
                            page: p
                        }) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {{ pagination.page >= pagination.pages ? 'disabled' : '' }}">
                    <a class="page-link" href="{{ path(consultation_index_route, {
                        patient: filters.patient ?? '',
                        personnel: filters.personnel ?? '',
                        date: filters.date ?? '',
                        page: pagination.page + 1
                    }) }}">Suivant</a>
                </li>
            </ul>
        </nav>
    </div>
{% endif %}
</div>

<div class="consultation-toast toast-container">
    <div id="consultationErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">Une erreur est survenue.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="consultationEditModal" tabindex="-1" aria-labelledby="consultationEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationEditModalLabel">Modifier Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="consultationNewModal" tabindex="-1" aria-labelledby="consultationNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationNewModalLabel">Nouvelle Consultation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="rapportNewModal" tabindex="-1" aria-labelledby="rapportNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rapportNewModalLabel">Nouveau rapport medical</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="prescriptionNewModal" tabindex="-1" aria-labelledby="prescriptionNewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prescriptionNewModalLabel">Nouvelle prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small">Chargement...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade consultation-modal" id="consultationDeleteModal" tabindex="-1" aria-labelledby="consultationDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationDeleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">Voulez-vous vraiment supprimer cette consultation ?</div>
                <div class="fw-semibold" data-delete-name></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                <form method="post" action="">
                    <input type="hidden" name="_token" value="">
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.js-auto-dismiss-alert').forEach((alertEl) => {
        window.setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
            alertInstance.close();
        }, 1000);
    });

    const editModal = document.getElementById('consultationEditModal');
    const newModal = document.getElementById('consultationNewModal');
    const rapportNewModal = document.getElementById('rapportNewModal');
    const prescriptionNewModal = document.getElementById('prescriptionNewModal');
    const deleteModal = document.getElementById('consultationDeleteModal');
    const errorToastEl = document.getElementById('consultationErrorToast');
    const errorToast = errorToastEl ? bootstrap.Toast.getOrCreateInstance(errorToastEl, { delay: 4000 }) : null;
    const modalFormCache = new Map();
    if (!editModal && !newModal && !rapportNewModal && !prescriptionNewModal && !deleteModal) return;

    const showErrorToast = (message) => {
        if (!errorToastEl || !errorToast) return;
        const body = errorToastEl.querySelector('.toast-body');
        if (body) {
            body.textContent = message;
        }
        errorToast.show();
    };

    const isConsultationFieldValid = (field) => {
        if (!field || field.disabled) return false;
        const tag = (field.tagName || '').toLowerCase();
        const type = (field.type || '').toLowerCase();
        if (type === 'hidden' || type === 'submit' || type === 'button') return false;

        const value = (field.value || '').trim();
        if (value === '') return false;

        // Apply same practical checks used in rendez-vous forms.
        if (field.name && field.name.includes('[lieu]')) {
            return value.length >= 2 && value.length <= 255;
        }

        if (tag === 'select' || type === 'date' || type === 'time') {
            return value !== '';
        }

        return true;
    };

    const bindConsultationRealtimeValidation = (form) => {
        if (!form || form.dataset.validationBound === '1') return;
        form.dataset.validationBound = '1';

        const fields = form.querySelectorAll('input, select, textarea');
        fields.forEach((field) => {
            const refresh = () => {
                const valid = isConsultationFieldValid(field);
                field.classList.toggle('is-valid', valid);
                if (!valid) {
                    field.classList.remove('is-invalid');
                }
            };

            field.addEventListener('input', refresh);
            field.addEventListener('change', refresh);
            field.addEventListener('blur', refresh);
            refresh();
        });
    };

    const bindFormSubmit = (modal) => {
        const modalBody = modal.querySelector('.modal-body');
        if (!modalBody) return;
        const form = modalBody.querySelector('form');
        if (!form) return;

        bindConsultationRealtimeValidation(form);

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: form.method || 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                if (!response.ok) {
                    throw new Error("Impossible d'envoyer le formulaire.");
                }

                const html = await response.text();
                modalBody.innerHTML = html;
                bindFormSubmit(modal);
            } catch (e) {
                showErrorToast(e.message || 'Erreur lors de l\'envoi.');
            }
        });
    };

    const loadFormIntoModal = async (modal, url, options = {}) => {
        const useCache = Boolean(options.useCache);
        const modalBody = modal.querySelector('.modal-body');
        if (!modalBody) return;

        if (useCache && modalFormCache.has(url)) {
            modalBody.innerHTML = modalFormCache.get(url);
            bindFormSubmit(modal);
            return;
        }

        modalBody.innerHTML = '<div class="text-muted small">Chargement...</div>';
        try {
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) {
                throw new Error('Impossible de charger le formulaire.');
            }
            const html = await response.text();
            if (useCache) {
                modalFormCache.set(url, html);
            }
            modalBody.innerHTML = html;
            bindFormSubmit(modal);
        } catch (e) {
            modalBody.innerHTML = '<div class="alert alert-danger mb-0">Impossible de charger le formulaire.</div>';
            showErrorToast(e.message || 'Erreur de chargement.');
        }
    };

    const prefetchForm = async (url) => {
        if (!url || modalFormCache.has(url)) return;
        try {
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) return;
            modalFormCache.set(url, await response.text());
        } catch (_) {
            // Keep silent: prefetch should never block UI.
        }
    };

    if (editModal) {
        editModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const editUrl = trigger.getAttribute('data-edit-url');
            if (!editUrl) return;
            await loadFormIntoModal(editModal, editUrl);
        });
    }

    if (newModal) {
        newModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const newUrl = trigger.getAttribute('data-new-url');
            if (!newUrl) return;
            await loadFormIntoModal(newModal, newUrl, { useCache: true });
        });
    }

    if (rapportNewModal) {
        rapportNewModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const newUrl = trigger.getAttribute('data-new-url');
            if (!newUrl) return;
            await loadFormIntoModal(rapportNewModal, newUrl, { useCache: true });
        });
    }

    if (prescriptionNewModal) {
        prescriptionNewModal.addEventListener('show.bs.modal', async (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const newUrl = trigger.getAttribute('data-new-url');
            if (!newUrl) return;
            await loadFormIntoModal(prescriptionNewModal, newUrl, { useCache: true });
        });
    }

    if (newModal) {
        const trigger = document.querySelector('[data-bs-target="#consultationNewModal"][data-new-url]');
        const newUrl = trigger ? trigger.getAttribute('data-new-url') : null;
        if (newUrl) {
            window.setTimeout(() => { prefetchForm(newUrl); }, 300);
        }
    }

    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', (event) => {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const deleteUrl = trigger.getAttribute('data-delete-url');
            const deleteToken = trigger.getAttribute('data-delete-token');
            const deleteName = trigger.getAttribute('data-delete-name');
            const form = deleteModal.querySelector('form');
            const tokenInput = deleteModal.querySelector('input[name="_token"]');
            const nameLabel = deleteModal.querySelector('[data-delete-name]');
            if (form && deleteUrl) {
                form.setAttribute('action', deleteUrl);
            }
            if (tokenInput && deleteToken) {
                tokenInput.value = deleteToken;
            }
            if (nameLabel) {
                nameLabel.textContent = deleteName || '';
            }
        });
    }

    document.querySelectorAll('.js-delete-consultation').forEach((button) => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const modal = new bootstrap.Modal(deleteModal);
            modal.show(button);
        });
    });
});
</script>
{% endblock %}
