{% extends 'base.html.twig' %}
{% block title %}Forum - Posts
{% endblock %}

{% block body %}
	{% block stylesheets %}
		{{ parent() }}
		<link rel="stylesheet" href="{{ asset('css/forum.css') }}">
	{% endblock %}


	<div class="forum-wrap">
		<div class="container">

			<div class="forum-header">
				<div>
					<h2 class="forum-title">Posts</h2>
					<div class="text-muted">
						Elder<span style="color:var(--brand-orange);font-weight:900;">Health</span>Care Forum
					</div>
				</div>

				<a class="btn btn-brand" href="{{ path('forum_post_new') }}">
					<i class="bi bi-plus-circle"></i>
					New Post
				</a>
			</div>

			{% for post in posts %}
				<div class="post-card">

					<div class="post-card__top">
						<div class="post-meta">
							<h5>{{ post.title }}</h5>
							<div class="small">
								<i class="bi bi-clock"></i>
								{{ post.dateDeCreation|date('d/m/Y H:i') }}
							</div>
						</div>

						<span class="badge-soft {{ post.status == 'ACTIVE' ? 'badge-active' : 'badge-inactive' }}">
							{{ post.status }}
						</span>
					</div>

					<div class="post-card__body">
						<p class="post-content">{{ post.content|default('') }}</p>

						{% if post.imageName %}
							<div class="post-image-wrapper mt-3">
								<img src="{{ asset('uploads/posts/' ~ post.imageName) }}" alt="Post image" class="post-image">
							</div>
						{% endif %}

					</div>


					<div
						class="actions">
						{# Post edit icon #}
						<a class="icon-btn" title="Edit post" href="{{ path('forum_post_edit', {id: post.id}) }}">
							<i class="bi bi-pencil-square"></i>
						</a>

						{# Add comment button #}
						<a class="btn btn-outline-primary btn-pill btn-sm" href="{{ path('forum_comment_new', {postId: post.id}) }}">
							<i class="bi bi-chat-left-text"></i>
							Add Comment
						</a>

						{# Toggle comments dropdown (collapse) #}
						<button class="btn btn-outline-primary btn-pill btn-sm toggle-comments" type="button" data-bs-toggle="collapse" data-bs-target="#comments-{{ post.id }}" aria-expanded="false" aria-controls="comments-{{ post.id }}">
							<i class="bi bi-chat-dots"></i>
							Comments ({{ post.commentaires|length }})
							<i class="bi bi-chevron-down chev ms-1"></i>
						</button>

						{# Post delete icon #}
						<form method="post" action="{{ path('forum_post_delete', {id: post.id}) }}" onsubmit="return confirm('Delete this post?');" class="d-inline">
							<input type="hidden" name="_token" value="{{ csrf_token('delete_post_' ~ post.id) }}">
							<button class="icon-btn danger" title="Delete post" type="submit">
								<i class="bi bi-trash"></i>
							</button>
						</form>
					</div>

					{# Dropdown comments #}
					<div class="collapse" id="comments-{{ post.id }}">
						<div class="comments">

							{% if post.commentaires|length > 0 %}
								{% for c in post.commentaires %}
									<div class="comment-item">
										<div class="comment-top">
											<span>
												<i class="bi bi-clock-history"></i>
												{{ c.date|date('d/m/Y H:i') }}</span>
											<span class="badge-soft {{ c.status == 'ACTIVE' ? 'badge-active' : 'badge-inactive' }}">
												{{ c.status }}
											</span>
										</div>

										<div>{{ c.content }}</div>

										<div class="comment-actions">
											<a class="icon-btn" title="Edit comment" href="{{ path('forum_comment_edit', {postId: post.id, id: c.id}) }}">
												<i class="bi bi-pencil-square"></i>
											</a>

											<form method="post" action="{{ path('forum_comment_delete', {postId: post.id, id: c.id}) }}" onsubmit="return confirm('Delete this comment?');">
												<input type="hidden" name="_token" value="{{ csrf_token('delete_comment_' ~ c.id) }}">
												<button class="icon-btn danger" title="Delete comment" type="submit">
													<i class="bi bi-trash"></i>
												</button>
											</form>
										</div>
									</div>
								{% endfor %}
							{% else %}
								<div class="empty">No comments yet üôÇ</div>
							{% endif %}

						</div>
					</div>

				</div>
			{% else %}
				<div class="empty">No posts yet. Click ‚ÄúNew Post‚Äù to create one üôÇ</div>
			{% endfor %}

		</div>
	</div>

	 <script>
			  document.querySelectorAll('.toggle-comments').forEach(btn => {
			    const targetSel = btn.getAttribute('data-bs-target');
			    const target = document.querySelector(targetSel);
			    if (!target) return;
			
			    target.addEventListener('show.bs.collapse', () => {
			      const chev = btn.querySelector('.chev');
			      if (chev) chev.style.transform = 'rotate(180deg)';
			    });
			
			    target.addEventListener('hide.bs.collapse', () => {
			      const chev = btn.querySelector('.chev');
			      if (chev) chev.style.transform = 'rotate(0deg)';
			    });
			  });
			</script>
{% endblock %}
